<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>מערכת ניהול יחידתית – דמו</title>
<style>
  :root{
    --bg:#f1f5f9;
    --card:#ffffff;
    --ink:#0f172a;
    --muted:#64748b;
    --nav:#020617;
    --navBtn:#1e293b;
    --navActive:#2563eb;
    --border:#e2e8f0;
    --warnBg:#fde68a;
    --warnInk:#92400e;
    --dashBorder:#cbd5f5;
    --dashBg:#eef2ff;
    --dashInk:#3730a3;
    --goodBg:#dcfce7;
    --goodInk:#166534;
    --badBg:#fee2e2;
    --badInk:#991b1b;
  }
  body { margin:0; font-family: system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--ink); }
  header { background:#0f172a; color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px;}
  header h1 { font-size:16px; margin:0; line-height:1.2; }
  header .sub { font-size:12px; opacity:.75; }
  header .right { display:flex; align-items:center; gap:8px; }
  header button { background:#111827; border:1px solid rgba(255,255,255,.15); color:#fff; padding:8px 10px; border-radius:8px; font-size:12px; }
  nav { display:flex; gap:8px; flex-wrap:wrap; background:var(--nav); padding:8px; }
  nav button { background:var(--navBtn); color:#fff; border:none; padding:8px 10px; border-radius:8px; font-size:12px; }
  nav button.active { background:var(--navActive); }
  main { padding:16px; }
  .card { background:var(--card); border-radius:14px; padding:16px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,.08); border:1px solid var(--border);}
  .muted { color:var(--muted); font-size:13px; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; background:var(--warnBg); color:var(--warnInk); margin-left:6px; }
  .badgeGood { background:var(--goodBg); color:var(--goodInk); }
  .badgeBad { background:var(--badBg); color:var(--badInk); }
  .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:12px; }
  .placeholder { border:2px dashed var(--dashBorder); background:var(--dashBg); color:var(--dashInk); padding:14px; border-radius:12px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .pill { display:inline-flex; gap:6px; align-items:center; background:#f8fafc; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; color:#334155;}
  .loginWrap{ min-height: calc(100vh - 0px); display:flex; align-items:center; justify-content:center; padding:16px;}
  .loginCard{ width:min(560px, 100%); }
  .btn { width:100%; padding:12px 12px; border:none; border-radius:12px; font-weight:700; font-size:14px; cursor:pointer;}
  .btnPrimary{ background:#0f172a; color:#fff;}
  .btnLight{ background:#e2e8f0; color:#0f172a;}
  .btnRole{ background:#f8fafc; border:1px solid var(--border); color:#0f172a; text-align:right;}
  .btnRole strong{ display:block; font-size:14px;}
  .btnRole span{ display:block; font-size:12px; color:var(--muted); margin-top:2px;}
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  input{ width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); font-size:14px; }
  .divider{ height:1px; background:var(--border); margin:14px 0;}
  .hide{ display:none !important; }

  /* Demo tables + modal */
  table{ width:100%; border-collapse:collapse; font-size:13px; }
  th, td{ border:1px solid var(--border); padding:8px; text-align:right; vertical-align:top; }
  th{ background:#f8fafc; color:#0f172a; font-weight:700; }
  .tblActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start; }
  .btnSm{ padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:700; font-size:12px; }
  .btnSmPrimary{ background:#0f172a; color:#fff; border-color:#0f172a; }
  .btnSmDanger{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }
  .modalOverlay{ position:fixed; inset:0; background:rgba(2,6,23,.55); display:none; align-items:center; justify-content:center; padding:16px; z-index:50; }
  .modalOverlay.show{ display:flex; }
  .modal{ width:min(760px,100%); background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 12px 40px rgba(0,0,0,.25); overflow:hidden; }
  .modalHeader{ padding:12px 14px; background:#0f172a; color:#fff; display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .modalHeader h3{ margin:0; font-size:14px; }
  .modalBody{ padding:14px; }
  .modalFooter{ padding:12px 14px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
  .hintStar{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; background:#fde68a; color:#92400e; margin-inline-start:6px; }
  select{ padding:10px; border-radius:12px; border:1px solid var(--border); font-size:14px; background:#fff; }
  .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .kpi .pill{ background:#fff; }

</style>
</head>
<body>

<div id="app"></div>

<script>
/**
 * דמו יציב לנייד:
 * - אין React/Babel/CDN
 * - כל מודול “אמיתי” מסומן ⭐ (שרת)
 *
 * הרשאות (דמו) לפי היררכיה:
 * - חייל: אישי + צפייה בדברים שמוקצים לו/פלוגה
 * - שליש: תפריט HR + לו״ז לפי מסגרת
 * - לוגיסטיקה: לוגיסטיקה + לו״ז + הודעות
 * - אדמין פלוגתי: שליטה פלוגתית (לו״ז פלוגתי/צוותים/חיילים בפלוגה, הודעות פלוגה, אישורים פלוגתיים)
 * - אדמין גדודי: שליטה גדודית (כולל רוחב), אישורים, חיפוש חיילים
 * - מנהל מערכת: הכל
 */

const ROLE_DEFS = {
  soldier:        { label:'חייל',        name:'ישראל ישראלי', battalion:"ס׳5", platoon:'ס״פ א׳',      team:'צוות 1' },
  shalish:        { label:'שליש',        name:'שליש פלוגתי',  battalion:"ס׳5", platoon:'מפקדה', team:'שלישות' },
  logistics:      { label:'לוגיסטיקה',   name:'קצין לוגיסטיקה', battalion:'הכל', platoon:'מפקדה', team:'לוגיסטיקה' },

  platoon_admin:  { label:'אדמין פלוגתי', name:'מפקד פלוגה (דמו)', battalion:"ס׳5", platoon:'ס״פ א׳', team:'פיקוד פלוגתי' },
  battalion_admin:{ label:'אדמין גדודי',  name:'מג״ד (דמו)',       battalion:"ס׳5", platoon:'מפקדה', team:'פיקוד גדודי' },

  sys_admin:      { label:'מנהל מערכת',  name:'מנהל מערכת', battalion:'הכל', platoon:'מפקדה', team:'פיקוד' },
};

function scopeChip(user){
  // צ׳יפ שמציג “מה הטווח” של ההרשאות
  if(user.role === 'soldier') return 'טווח: אישי + פלוגה (צפייה)';
  if(user.role === 'shalish') return 'טווח: HR (לפי יחידה/פלוגה)';
  if(user.role === 'logistics') return 'טווח: לוגיסטיקה (רוחב יחידתי)';
  if(user.role === 'platoon_admin') return `טווח: פלוגה ${user.platoon} בלבד`;
  if(user.role === 'battalion_admin') return `טווח: גדוד ${user.battalion}`;
  if(user.role === 'sys_admin') return 'טווח: הכל';
  return 'טווח: לא ידוע';
}

function tabsForRole(role){
  // לוגיקת הרשאות דמו בלבד
  if(role === 'soldier'){
    return [
      { id:'home', label:'דף הבית' },
      { id:'my_schedule', label:'לו״ז שלי' },
      { id:'learning', label:'למידה' },
      { id:'logistics', label:'לוגיסטיקה' }, // כולל “ציוד” בפנים
      { id:'3010', label:'3010' },
      { id:'chat', label:'צ׳אט' },
      { id:'messages', label:'הודעות' },
      { id:'rashmatz', label:'רשמ״ץ' },

    ];
  }

  if(role === 'shalish'){
    return [
      { id:'dashboard', label:'תמונת מצב' },
      { id:'unit_schedule', label:'לו״ז (הוספה לפי הרשאה)' },
      { id:'hr', label:'שלישות' },
      { id:'learning_admin', label:'למידה (ניהול)' },
      { id:'soldier_search', label:'חיפוש חייל' },
      { id:'messages', label:'הודעות' },
      { id:'small_forces', label:'כוחות קטנים' },
      { id:'rashmatz', label:'רשמ״ץ' },


    ];
  }

  if(role === 'logistics'){
    return [
      { id:'dashboard', label:'תמונת מצב' },
      { id:'unit_schedule', label:'לו״ז (הוספה לפי הרשאה)' },
      { id:'logistics', label:'לוגיסטיקה' },
      { id:'messages', label:'הודעות' },
      { id:'rashmatz', label:'רשמ״ץ' },

    ];
  }

  if(role === 'platoon_admin'){
    return [
      { id:'dashboard', label:'תמונת מצב' },
      { id:'platoon_hr', label:'שלישות פלוגתית' },
      { id:'platoon_schedule', label:'לו״ז ומשימות פלוגתי' },
      { id:'logistics', label:'לוגיסטיקה' },
      { id:'platoon_messages', label:'הודעות פלוגה' },
      { id:'approvals_platoon', label:'אישורים פלוגתיים' },
      { id:'learning_admin', label:'למידה (ניהול)' },
      { id:'rashmatz', label:'רשמ״ץ' },

    ];
  }

  if(role === 'battalion_admin'){
    return [
      { id:'dashboard', label:'תמונת מצב' },
      { id:'unit_schedule', label:'לו״ז ומשימות גדודי/רוחב' },
      { id:'soldier_search', label:'חיפוש חייל' },
      { id:'approvals', label:'אישורים' },
      { id:'hr', label:'שלישות' },
      { id:'logistics', label:'לוגיסטיקה' },
      { id:'messages', label:'הודעות' },
      { id:'learning_admin', label:'למידה (ניהול)' },
      { id:'soldier_search', label:'חיפוש חייל' },
      { id:'small_forces', label:'כוחות קטנים' },
      { id:'rashmatz', label:'רשמ״ץ' },


    ];
  }

  // sys_admin
  return [
    { id:'dashboard', label:'תמונת מצב' },
    { id:'unit_schedule', label:'לו״ז ומשימות יחידתי' },
    { id:'soldier_search', label:'חיפוש חייל' },
    { id:'approvals', label:'אישורים' },
    { id:'hr', label:'שלישות' },
    { id:'logistics', label:'לוגיסטיקה' },
    { id:'learning_admin', label:'למידה (ניהול)' },
      { id:'soldier_search', label:'חיפוש חייל' },
    { id:'messages', label:'הודעות' },
  ];
}

function screenTitle(user){
  const r = ROLE_DEFS[user.role];
  if(!r) return '';
  // הצגה קצרה
  if(user.role === 'sys_admin') return `${r.label}`;
  return `${r.label} • ${user.battalion}/${user.platoon}`;
}

function escapeHtml(s){
  return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

function nowTime(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}


// -----------------------------
// Demo data (ללא שרת) – להמחשה בלבד
// -----------------------------
const DEMO_DB = {
  // רשמ"ץ + כתום בעיניים (דמו)
  rashmatz: [],
  orangeEyes: { items: [], lastCheckedAt: null, lastCheckedBy: '' },
  sabotage: { inventory: [], usage: [] },
  _rashmatzUI: { view:'platoon' },
  soldiers: [
    { id:'1001', name:'נועם כהן', battalion:"ס׳3", platoon:'א', team:'צוות 1', order:true,  outTask:false, notes:'',          medical:'', mos:[
      { type:'חובש' },
      { type:'נהג ב', permits:'B, טרקטורון' }
    ]},
    { id:'1002', name:'איתי לוי', battalion:"ס׳3", platoon:'א', team:'צוות 1', order:true,  outTask:true,  notes:'משימות חוץ', medical:'', mos:[
      { type:'סלק' }
    ]},
    { id:'1003', name:'יובל מזרחי', battalion:"ס׳3", platoon:'א', team:'צוות 2', order:false, outTask:false, notes:'לא בצו',    medical:'גימלים עד מחר', mos:[
      { type:'מטיס רחפן', drone:'DJI Mavic 3', mirrorSystem:true }
    ]},
    { id:'1004', name:'אורן דגן', battalion:"ס׳3", platoon:'ב', team:'צוות 1', order:true,  outTask:false, notes:'',          medical:'', mos:[
      { type:'נהג ג', permits:'C, מנוף' }
    ]},
  ],

  soldierLogistics: {
    '1001': {
      equipment:[
        {name:'ווסט', sku:'VST-001', qty:1},
        {name:'מחסניות 5.56', sku:'MAG-556', qty:8},
        {name:'קסדה', sku:'HLM-002', qty:1},
        {name:'אפוד קרמי', sku:'ARM-007', qty:1},
      ],
      weapons:[
        {name:'M4', sku:'WPN-M4-001', serial:'A12345'},
      ],
      amaral:[
        {name:'אמר"ל קשר', sku:'COM-010', qty:1},
      ]
    },
    '1002': {
      equipment:[
        {name:'ווסט', sku:'VST-001', qty:1},
        {name:'מחסניות 5.56', sku:'MAG-556', qty:6},
        {name:'אוזניות', sku:'COM-012', qty:1},
      ],
      weapons:[
        {name:'M4', sku:'WPN-M4-001', serial:'B77110'},
      ],
      amaral:[
        {name:'ערכת עזרה ראשונה', sku:'MED-001', qty:1},
      ]
    },
    '1003': {
      equipment:[
        {name:'ווסט', sku:'VST-001', qty:1},
        {name:'מחסניות 5.56', sku:'MAG-556', qty:7},
        {name:'ערכת רחפן', sku:'DRN-KIT-01', qty:1},
      ],
      weapons:[
        {name:'Tavor', sku:'WPN-TVR-002', serial:'T90811'},
      ],
      amaral:[
        {name:'משקפת', sku:'OPT-001', qty:1},
      ]
    },
    '1004': {
      equipment:[
        {name:'ווסט', sku:'VST-001', qty:1},
        {name:'מחסניות 5.56', sku:'MAG-556', qty:8},
        {name:'קסדה', sku:'HLM-002', qty:1},
      ],
      weapons:[
        {name:'M4', sku:'WPN-M4-001', serial:'C55120'},
      ],
      amaral:[
        {name:'אמר"ל קשר', sku:'COM-010', qty:1},
      ]
    },
  },

  inventory: [
    { name:'ווסט', sku:'VST-001', inStock:12 },
    { name:'מחסניות 5.56', sku:'MAG-556', inStock:3 },
    { name:'קסדה', sku:'HLM-002', inStock:0 },
    { name:'ערכת עזרה ראשונה', sku:'MED-001', inStock:7 },
    { name:'אמר"ל קשר', sku:'COM-010', inStock:1 },
    { name:'ערכת רחפן', sku:'DRN-KIT-01', inStock:2 },
  ],

  platoonSchedule: [
    { when:'08:00', title:'מסדר בוקר', scope:'פלוגתי' },
    { when:'09:00', title:'אימון יבש', scope:'צוותי' },
    { when:'12:30', title:'ארוחת צהריים', scope:'פלוגתי' },
    { when:'14:00', title:'מטווח', scope:'פלוגתי' },
  ],

  personalTasks: [
    { who:'1001', title:'קריאת נוהל בטיחות מטווח', due:'היום', status:'פתוח' },
    { who:'1001', title:'השלמת מערך קשר',           due:'מחר',  status:'פתוח' },
    { who:'1002', title:'בדיקת ציוד לפני יציאה',     due:'היום', status:'פתוח' },
    { who:'1003', title:'החזרת ציוד – חתימה',        due:'היום', status:'ממתין' },
  ],

  messages: [
    { id:'msg-001', title:'היערכות מסדר', body:'מסדר בוקר בשעה 08:00. חובה הגעה בזמן.', from:'מפקד פלוגה', time:'07:10' },
    { id:'msg-002', title:'ציוד מטווח', body:'נא להביא אטמי אוזניים ומחסניות תקינות.', from:'לוגיסטיקה', time:'10:05' },
  ],
};

// -----------------------------
// ⭐ Seed full demo data (ללא שרת) – יוסר בחיבור לשרת
// מייצר "מערכת פעילה" עם חיילים/ציוד/לו״ז/משימות/הודעות (דמו בלבד)
// -----------------------------
function seedFullDemoData(){
  try{
    // אם כבר יש חיילים אמיתיים/דמו - לא נדרוס
    if((DEMO_DB.soldiers||[]).length > 10) return;

    const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
    const pick = (arr)=>arr[randInt(0,arr.length-1)];
    const shuffleUnique = (arr)=>{
      const out=[];
      arr.forEach(x=>{ if(!out.includes(x)) out.push(x); });
      return out;
    };

    // Battalions and S5 platoons
    DEMO_DB.battalions = DEMO_DB.battalions || ["ס׳3","ס׳4","ס׳5","כוחות קטנים"];
    const platoonsS5 = ["ס״פ א׳","ס״פ ב׳","תופז","גבעול","יאפ דרום","ספיר צפון","ספיר דרום","ספיר מרכז"];
    const teams = ["א","ב","ג","ד"];

    // Catalogs for visual
    const weapons = [
      { type:"M4", sku:"WPN-M4-001" },
      { type:"Tavor", sku:"WPN-TVR-014" },
      { type:"Negev", sku:"WPN-NGV-110" }
    ];
    const gearCatalog = [
      { name:"ווסט", sku:"VST-001" },
      { name:"קסדה", sku:"HLM-014" },
      { name:"מחסניות", sku:"MAG-556" },
      { name:"מימיה", sku:"WTB-002" },
      { name:"משקפי מגן", sku:"EYE-120" },
      { name:"ברכיות", sku:"KNE-010" },
      { name:"פנס", sku:"FLA-031" },
      { name:"שק״ש", sku:"SLP-201" }
    ];
    const mosOptions = ["לוחם","סלק","חובש","נהג ב","נהג ג","מטיס רחפן","מערכת שיקוף"];

    const today = new Date();
    const iso = (d)=>d.toISOString().slice(0,10);
    const addDays = (d,days)=>{ const x=new Date(d); x.setDate(x.getDate()+days); return x; };

    DEMO_DB.soldiers = [];
    DEMO_DB.logistics = DEMO_DB.logistics || { issues:[], approvals:[] };
    DEMO_DB.logisticRequests = DEMO_DB.logisticRequests || [];
    DEMO_DB.messages = DEMO_DB.messages || [];
    DEMO_DB.personalTasks = DEMO_DB.personalTasks || [];
    DEMO_DB.platoonSchedule = DEMO_DB.platoonSchedule || [];
    DEMO_DB.boards = DEMO_DB.boards || { shalish_only:[], hr_admins:[] };

    // Create soldiers per platoon
    let serial = 1001;
    platoonsS5.forEach((platoon)=>{
      const enlisted = randInt(5,10);
      const notEnlisted = randInt(5,10);

      function mkSoldier(isEnlisted){
        const id = String(serial++);
        const team = pick(teams);
        const name = `${pick(["נועם","אור","רון","איתי","שחר","דניאל","עידו","גיל","שקד","עמית","אופק","עומר"])} ${pick(["כהן","לוי","מזרחי","פרץ","אברהם","חזן","דוד","חדד","רז","מלכה"])}`;
        const status = isEnlisted ? "מגויס" : "משוחרר";
        const openedAt = isEnlisted ? iso(addDays(today, -randInt(1,40))) : "";
        const releaseAt = isEnlisted ? iso(addDays(today, randInt(5,60))) : "";
        const mos = shuffleUnique([pick(mosOptions), pick(mosOptions)]);
        const weapon = (Math.random()<0.75) ? pick(weapons) : null;

        // Random gear items
        const gearCount = randInt(2,6);
        const gear = [];
        const used = new Set();
        while(gear.length<gearCount){
          const g = pick(gearCatalog);
          if(used.has(g.sku)) continue;
          used.add(g.sku);
          gear.push({ name:g.name, sku:g.sku, qty: randInt(1,4), location:"אצל החייל", signed:true });
        }

        return {
          id,
          name,
          battalion:"ס׳5",
          platoon,
          team,
          role:"soldier",
          rank: pick(["רב״ט","טוראי","סמל","סמ״ר"]),
          phone: `05${randInt(0,9)}-${randInt(1000000,9999999)}`,
          email: `soldier${id}@demo.local`,
          status,
          tzStatus: status,
          orderOpenDate: openedAt,
          orderCloseDate: releaseAt,
          orderNotes: "",
          mos,
          weapon: weapon ? { type: weapon.type, sku: weapon.sku, serial: `SN-${randInt(10000,99999)}` } : null,
          armel: { name: pick(["אמר״ל A","אמר״ל B","אמר״ל C"]), sku: `ARM-${randInt(100,999)}` },
          gear,
          createdAt: new Date().toISOString()
        };
      }

      for(let i=0;i<enlisted;i++) DEMO_DB.soldiers.push(mkSoldier(true));
      for(let i=0;i<notEnlisted;i++) DEMO_DB.soldiers.push(mkSoldier(false));
    });

    // Seed messages/tasks/schedule boards (visual)
    DEMO_DB.messages.unshift(
      { id:"msg-seed-001", title:"עדכון מערכת (דמו)", body:"המערכת מוצגת כפעילה עם נתוני דמו ⭐", from:"מערכת", time: nowTime() },
      { id:"msg-seed-002", title:"תזכורת חתימות", body:"לבדוק חתימות ציוד לפני יציאה ⭐", from:"לוגיסטיקה", time: nowTime() }
    );

    DEMO_DB.personalTasks.unshift(
      { id:"tsk-seed-001", title:"בדיקת מלאי קסדות ⭐", createdBy:"לוגיסטיקה", createdAt:new Date().toISOString(), done:false, doneBy:"", doneAt:"", note:"" },
      { id:"tsk-seed-002", title:"עדכון נתוני צו ⭐", createdBy:"שלישות", createdAt:new Date().toISOString(), done:false, doneBy:"", doneAt:"", note:"" }
    );

    // schedule (few platoons)
    platoonsS5.slice(0,4).forEach((pl, idx)=>{
      DEMO_DB.platoonSchedule.push({ id:`sch-seed-${idx+1}`, platoon:pl, time:"08:00", title:"מסדר בוקר", owner:"אדמין פלוגתי", createdAt:new Date().toISOString(), approved:false });
      DEMO_DB.platoonSchedule.push({ id:`sch-seed-${idx+20}`, platoon:pl, time:"19:30", title:"תדריך ערב", owner:"שליש", createdAt:new Date().toISOString(), approved:true });
    });

    // Boards
    DEMO_DB.boards.shalish_only.unshift(
      { id:"brd-s-1", type:"msg", title:"לוח שלישים (דמו)", body:"עדכונים בין שלישים בלבד ⭐", createdBy:"שליש גדודי", createdAt:new Date().toISOString() },
      { id:"brd-s-2", type:"task", title:"הקמת רשימת צוים", body:"לעדכן צפי שחרור לכל הפלוגות ⭐", createdBy:"שליש", createdAt:new Date().toISOString(), done:false, doneBy:"", doneAt:"", note:"" }
    );
    DEMO_DB.boards.hr_admins.unshift(
      { id:"brd-ha-1", type:"req", title:"בקשת ציוד", body:"מחסניות 5.56 – 200 יח׳ ⭐", createdBy:"אדמין ס״פ א׳", createdAt:new Date().toISOString(), status:"ממתין", answeredBy:"", answeredAt:"" }
    );

  } catch(e){
    console.error("seedFullDemoData failed", e);
  }
}
(function(){
  seedFullDemoData();
})();

function fmtDate(d){
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = d.getFullYear();
  return `${yy}-${mm}-${dd}`;
}
function uid(prefix='id'){
  return `${prefix}-${Math.random().toString(16).slice(2,8)}-${Date.now().toString(16)}`;
}

// בקשות ציוד (דמו – נשמר בזיכרון בלבד)
const DEMO_STATE = {
  requests: [
    {
      id:'req-001',
      createdAt:fmtDate(new Date()),
      scope:'פלוגה א',
      requesterRole:'אדמין פלוגתי',
      requesterName:'מפקד פלוגה (דמו)',
      items:[
        {product:'קסדה', qty:2, decision:'pending'},
        {product:'אמר"ל קשר', qty:1, decision:'pending'},
      ],
      note:'דמו: בקשה לציוד לקראת אימון.',
    }
  ],
  logisticsSubTab: 'requests',
};

const MOS_TYPES = [
  'סלק',
  'חובש',
  'נהג ג',
  'נהג ב',
  'מטיס רחפן',
  'מערכת שיקוף',
];

const DRONE_TYPES = [
  'DJI Mavic 3',
  'Skydio 2',
  'Autel EVO II',
  'אחר',
];

function mosToText(m){
  if(!m) return '';
  if(m.type === 'נהג ב' || m.type === 'נהג ג'){
    return `${m.type}${m.permits ? ` (היתרים: ${m.permits})` : ''}`;
  }
  if(m.type === 'מטיס רחפן'){
    const ms = m.mirrorSystem ? ' + מערכת שיקוף' : '';
    return `${m.type}${m.drone ? ` (${m.drone})` : ''}${ms}`;
  }
  if(m.type === 'מערכת שיקוף'){
    return 'מערכת שיקוף';
  }
  return m.type;
}

function computeRequestStatus(req){
  const decisions = (req.items||[]).map(i=>i.decision);
  if(decisions.includes('needs_agam')) return 'ממתין לאישור אגם';
  if(decisions.includes('out_of_stock')) return 'חסר מלאי';
  if(decisions.every(d=>d==='in_stock')) return 'אושר (במלאי)';
  if(decisions.some(d=>d==='in_stock')) return 'חלקי / בטיפול';
  return 'בטיפול';
}

function visibleSoldiersFor(user){
  // דמו של סינון לפי הרשאות
  if(!user) return [];
  if(user.role === 'soldier') return DEMO_DB.soldiers.filter(s=>s.id==='1001'); // החייל בדמו רואה "עצמו"
  if(user.role === 'platoon_admin') return DEMO_DB.soldiers.filter(s=>s.platoon === user.platoon);
  if(user.role === 'battalion_admin') return DEMO_DB.soldiers.filter(s=>s.battalion === user.battalion);
  if(user.role === 'shalish') return DEMO_DB.soldiers.filter(s=>s.battalion === user.battalion);
  if(user.role === 'logistics') return DEMO_DB.soldiers; // רוחב יחידתי בדמו
  if(user.role === 'sys_admin') return DEMO_DB.soldiers;
  return DEMO_DB.soldiers;
}

function openModal(type, payload={}){
  state.modal = { type, ...payload };
  renderApp();
}
function closeModal(){
  state.modal = null;
  renderApp();
}

function renderModal(){
  if(!state.modal) return '';
  const m = state.modal;

  if(m.type === 'register_soldier'){
    const rows = (m.form?.mosRows || []);
    return `
      <div class="modalOverlay" role="dialog" aria-modal="true">
        <div class="modal">
          <div class="modalHeader">
            <h3>רישום חייל חדש ⭐</h3>
            <button class="btnSm" id="modalClose">סגור</button>
          </div>
          <div class="modalBody">
            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
              <div>
                <div class="muted" style="margin-bottom:6px;">שם מלא</div>
                <input id="regName" value="${escapeHtml(m.form.name||'')}" placeholder="לדוגמה: דניאל ישראלי" />
              </div>
              <div>
                <div class="muted" style="margin-bottom:6px;">מספר אישי</div>
                <input id="regId" value="${escapeHtml(m.form.id||'')}" placeholder="לדוגמה: 1010" />
              </div>
              <div>
                <div class="muted" style="margin-bottom:6px;">גדוד</div>
                <input id="regBattalion" value="${escapeHtml(m.form.battalion||'ס׳3')}" />
              </div>
              <div>
                <div class="muted" style="margin-bottom:6px;">פלוגה</div>
                <input id="regPlatoon" value="${escapeHtml(m.form.platoon||'א')}" placeholder="א / ב / מפקדה" />
              </div>
              <div>
                <div class="muted" style="margin-bottom:6px;">צוות</div>
                <input id="regTeam" value="${escapeHtml(m.form.team||'צוות 1')}" />
              </div>
            </div>

            <div class="divider"></div>

            <div class="row" style="justify-content:space-between;">
              <div>
                <strong>מקצועות צה״ליים ⭐</strong>
                <div class="muted">מילוי ידני + שדות מיוחדים לנהגים/רחפן.</div>
              </div>
              <button class="btnSm" id="addMosRow">➕ הוסף מקצוע</button>
            </div>

            <div style="height:10px;"></div>
            <table class="table">
              <thead>
                <tr>
                  <th style="width:28%;">מקצוע</th>
                  <th>פרטים</th>
                  <th style="width:90px;">פעולות</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map((r, idx)=>`
                  <tr>
                    <td>
                      <select class="mosType" data-idx="${idx}">
                        ${MOS_TYPES.map(t=>`<option value="${escapeHtml(t)}" ${t===r.type?'selected':''}>${escapeHtml(t)}</option>`).join('')}
                      </select>
                    </td>
                    <td>
                      ${ (r.type==='נהג ב' || r.type==='נהג ג') ? `
                        <div class="muted" style="margin-bottom:6px;">היתרי נהיגה (לדוגמה: B, C, מנוף)</div>
                        <input class="mosPermits" data-idx="${idx}" value="${escapeHtml(r.permits||'')}" placeholder="B, C, מנוף..." />
                      ` : ''}

                      ${ (r.type==='מטיס רחפן') ? `
                        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px;">
                          <div>
                            <div class="muted" style="margin-bottom:6px;">איזה רחפן</div>
                            <select class="mosDrone" data-idx="${idx}">
                              ${DRONE_TYPES.map(d=>`<option value="${escapeHtml(d)}" ${d===(r.drone||'DJI Mavic 3')?'selected':''}>${escapeHtml(d)}</option>`).join('')}
                            </select>
                          </div>
                          <div>
                            <div class="muted" style="margin-bottom:6px;">מערכת שיקוף</div>
                            <label class="pill" style="gap:8px; width:max-content;">
                              <input type="checkbox" class="mosMirror" data-idx="${idx}" ${r.mirrorSystem?'checked':''} />
                              יש מערכת שיקוף
                            </label>
                          </div>
                        </div>
                      ` : ''}

                      ${ (r.type==='סלק' || r.type==='חובש' || r.type==='מערכת שיקוף') ? `
                        <div class="muted">—</div>
                      ` : '' }
                    </td>
                    <td>
                      <button class="btnSm" data-del-mos="${idx}">מחק</button>
                    </td>
                  </tr>
                `).join('')}

                ${rows.length===0 ? `<tr><td colspan="3" class="muted">אין עדיין מקצועות. לחצי “הוסף מקצוע”.</td></tr>` : ``}
              </tbody>
            </table>

            <div class="divider"></div>
            <div class="muted">⭐ בדמו: נשמר בזיכרון בלבד. בשרת יישמר במסד נתונים ויוצג בכרטיס חייל לשליש/אדמין.</div>
          </div>
          <div class="modalFooter">
            <button class="btnSm btnSmPrimary" id="saveRegister">שמירה</button>
            <button class="btnSm" id="cancelRegister">ביטול</button>
          </div>
        </div>
      </div>
    `;
  }

if(m.type === 'request_equipment'){
  const rows = (m.form?.items || []);
  return `
    <div class="modalOverlay" role="dialog" aria-modal="true">
      <div class="modal">
        <div class="modalHeader">
          <h3>בקשה לציוד לוגיסטי ⭐</h3>
          <button class="btnSm" id="modalClose">סגור</button>
        </div>
        <div class="modalBody">
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
            <div>
              <div class="muted" style="margin-bottom:6px;">תחום/מסגרת</div>
              <input id="reqScope" value="${escapeHtml(m.form.scope||'')}" placeholder="פלוגה א / גדוד ס׳3 / רוחב" />
            </div>
            <div>
              <div class="muted" style="margin-bottom:6px;">הערה לבקשה</div>
              <input id="reqNote" value="${escapeHtml(m.form.note||'')}" placeholder="לדוגמה: לקראת אימון..." />
            </div>
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between;">
            <strong>פריטים</strong>
            <button class="btnSm" id="addReqRow">➕ שורה</button>
          </div>

          <div style="height:10px;"></div>
          <table class="table">
            <thead><tr><th>מוצר</th><th style="width:140px;">כמות</th><th style="width:90px;">פעולות</th></tr></thead>
            <tbody>
              ${rows.map((r, idx)=>`
                <tr>
                  <td><input class="reqProd" data-idx="${idx}" value="${escapeHtml(r.product||'')}" placeholder="ווסט / קסדה / ..." /></td>
                  <td><input class="reqQty" data-idx="${idx}" value="${escapeHtml(String(r.qty||''))}" /></td>
                  <td><button class="btnSm" data-del-req="${idx}">מחק</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <div class="divider"></div>
          <div class="muted">⭐ בשרת: ישמר, ישלח ללוגיסטיקה, ויתווסף סטטוס כללי + לוג לכל שינוי.</div>
        </div>
        <div class="modalFooter">
          <button class="btnSm btnSmPrimary" id="submitReq">שליחת בקשה</button>
          <button class="btnSm" id="cancelReq">ביטול</button>
        </div>
      </div>
    </div>
  `;
}

  return '';
}

function wireModal(){
  if(!state.modal) return;
  const m = state.modal;

  const closeBtn = document.getElementById('modalClose');
  if(closeBtn) closeBtn.addEventListener('click', closeModal);

  const cancel = document.getElementById('cancelRegister');
  if(cancel) cancel.addEventListener('click', closeModal);

  if(m.type === 'register_soldier'){
    const f = m.form;

    const add = document.getElementById('addMosRow');
    if(add) add.addEventListener('click', ()=>{
      f.mosRows.push({ type:'סלק' });
      renderApp();
    });

    document.querySelectorAll('[data-del-mos]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const idx = Number(b.getAttribute('data-del-mos'));
        f.mosRows.splice(idx,1);
        renderApp();
      });
    });

    document.querySelectorAll('.mosType').forEach(sel=>{
      sel.addEventListener('change', ()=>{
        const idx = Number(sel.getAttribute('data-idx'));
        const t = sel.value;
        const row = f.mosRows[idx] || {};
        // reset special fields when switching type
        f.mosRows[idx] = { type:t };
        if(t==='מטיס רחפן'){ f.mosRows[idx].drone = 'DJI Mavic 3'; f.mosRows[idx].mirrorSystem = false; }
        renderApp();
      });
    });

    document.querySelectorAll('.mosPermits').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const idx = Number(inp.getAttribute('data-idx'));
        f.mosRows[idx].permits = inp.value;
      });
    });
    document.querySelectorAll('.mosDrone').forEach(sel=>{
      sel.addEventListener('change', ()=>{
        const idx = Number(sel.getAttribute('data-idx'));
        f.mosRows[idx].drone = sel.value;
      });
    });
    document.querySelectorAll('.mosMirror').forEach(ch=>{
      ch.addEventListener('change', ()=>{
        const idx = Number(ch.getAttribute('data-idx'));
        f.mosRows[idx].mirrorSystem = !!ch.checked;
      });
    });

    // bind top fields
    const bind = (id, key)=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', ()=>{ f[key] = el.value; });
    };
    bind('regName','name');
    bind('regId','id');
    bind('regBattalion','battalion');
    bind('regPlatoon','platoon');
    bind('regTeam','team');

    const save = document.getElementById('saveRegister');
    if(save) save.addEventListener('click', ()=>{
      const id = (f.id||'').trim();
      const name = (f.name||'').trim();
      if(!id || !name){
        alert('חובה למלא שם ומספר אישי (דמו).');
        return;
      }
      if(DEMO_DB.soldiers.some(s=>s.id===id)){
        alert('מספר אישי כבר קיים (דמו).');
        return;
      }
      DEMO_DB.soldiers.push({
        id,
        name,
        battalion: (f.battalion||'ס׳3').trim(),
        platoon: (f.platoon||'א').trim(),
        team: (f.team||'צוות 1').trim(),
        order:true,
        outTask:false,
        notes:'',
        medical:'',
        mos: (f.mosRows||[]).map(r=>({...r})),
      });
      // init logistics baseline
      DEMO_DB.soldierLogistics[id] = {
        equipment:[
          {name:'ווסט', sku:'VST-001', qty:1},
          {name:'מחסניות 5.56', sku:'MAG-556', qty:6},
        ],
        weapons:[
          {name:'M4', sku:'WPN-M4-001', serial: uid('SER').slice(-6).toUpperCase() }
        ],
        amaral:[
          {name:'אמר"ל קשר', sku:'COM-010', qty:1},
        ],
      };
      closeModal();
      alert('החייל נרשם בדמו ✅ (⭐ בשרת יישמר במסד נתונים).');
    });
  }


  if(m.type === 'request_equipment'){
    const f = m.form;

    const bind = (id, key)=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', ()=>{ f[key] = el.value; });
    };
    bind('reqScope','scope');
    bind('reqNote','note');

    const add = document.getElementById('addReqRow');
    if(add) add.addEventListener('click', ()=>{
      f.items.push({ product:'', qty:1 });
      renderApp();
    });

    document.querySelectorAll('[data-del-req]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const idx = Number(b.getAttribute('data-del-req'));
        f.items.splice(idx,1);
        renderApp();
      });
    });

    document.querySelectorAll('.reqProd').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const idx = Number(inp.getAttribute('data-idx'));
        f.items[idx].product = inp.value;
      });
    });
    document.querySelectorAll('.reqQty').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const idx = Number(inp.getAttribute('data-idx'));
        const v = Number(inp.value);
        f.items[idx].qty = Number.isFinite(v) && v>0 ? v : 1;
      });
    });

    const cancel = document.getElementById('cancelReq');
    if(cancel) cancel.addEventListener('click', closeModal);

    const submit = document.getElementById('submitReq');
    if(submit) submit.addEventListener('click', ()=>{
      const items = (f.items||[]).filter(x=>(x.product||'').trim());
      if(items.length===0){
        alert('צריך לפחות מוצר אחד (דמו).');
        return;
      }
      const req = {
        id: uid('req'),
        createdAt: fmtDate(new Date()),
        scope: (f.scope||'').trim() || 'לא צוין',
        requesterRole: roleLabel(state.user.role),
        requesterName: state.user.name,
        items: items.map(x=>({ product:(x.product||'').trim(), qty:x.qty||1, decision:'pending' })),
        note: (f.note||'').trim(),
      };
      DEMO_STATE.requests.unshift(req);
      closeModal();
      alert('הבקשה נשלחה בדמו ✅ (⭐ בשרת: תישמר ותיכנס לטיפול לוגיסטיקה).');
    });
  }

}

function roleLabel(role){ return (ROLE_DEFS[role]||{}).label || role; }

function soldierById(id){ return DEMO_DB.soldiers.find(s=>s.id===id); }

function soldiersInScope(user){
  if(user.role==='platoon_admin') return DEMO_DB.soldiers.filter(s=>s.platoon===user.platoon);
  if(user.role==='battalion_admin' || user.role==='sys_admin' || user.role==='shalish' || user.role==='logistics') return DEMO_DB.soldiers;
  return DEMO_DB.soldiers.filter(s=>s.id==='1001'); // חייל בדמו רואה "עצמו"
}

const Screens = {
  home: (user)=>`
    <h2>דף הבית</h2>
    <div class="row">
      <span class="pill">מחובר/ת כ: <strong>${escapeHtml(ROLE_DEFS[user.role].label)}</strong></span>
      <span class="pill">יחידה/גדוד: <strong>${escapeHtml(user.battalion)}</strong></span>
      <span class="pill">פלוגה: <strong>${escapeHtml(user.platoon)}</strong></span>
      <span class="pill">שעה: <strong>${nowTime()}</strong></span>
      <span class="pill">${escapeHtml(scopeChip(user))}</span>
    </div>
    <div class="divider"></div>
    <p class="muted">כאן החייל רואה משימות, אירועים קרובים, הודעות וימי הולדת (⭐ שרת + יומן Google).</p>
    <div class="grid">
      <div class="placeholder">משימות להיום ⭐</div>
      <div class="placeholder">אירועים קרובים ⭐</div>
      <div class="placeholder">ימי הולדת בפלוגה ⭐</div>
    </div>
  `,

  my_schedule: (user)=>`
    <h2>לו״ז שלי <span class="badge">⭐ שרת</span></h2>
    <p class="muted">בדמו: הצגה של אירועים אישיים + פלוגתיים לדוגמה. בפרודקשן זה יגיע מהשרת/Google Calendar.</p>

    <div class="divider"></div>

    <table>
      <thead><tr><th style="width:90px;">שעה</th><th>אירוע</th><th style="width:120px;">סוג</th></tr></thead>
      <tbody>
        <tr><td>08:00</td><td>מסדר בוקר</td><td>פלוגתי ⭐</td></tr>
        <tr><td>09:30</td><td>תרגול אישי – נשק</td><td>אישי ⭐</td></tr>
        <tr><td>14:00</td><td>מטווח</td><td>פלוגתי ⭐</td></tr>
      </tbody>
    </table>

    <div style="height:10px;"></div>
    <div class="placeholder">תזכורות/התראות לפי הרשאה ⭐</div>
  `,

  unit_schedule: (user)=>`
    <h2>לו״ז ומשימות – לפי הרשאה <span class="badge">⭐ שרת</span></h2>
    <p class="muted">
      כאן יופיע טופס הוספת אירוע וגם יצירת משימות בהתאם לתפקיד.
      <br/>
      <strong>מי רואה מה?</strong>
      <br/>• מנהל מערכת: הכל
      <br/>• אדמין גדודי: גדוד + אירועי רוחב
      <br/>• שליש: לפי ההקצאה (בדמו)
      <br/>• לוגיסטיקה: לפי יחידה (בדמו)
    </p>
    <div class="grid">
      <div class="placeholder">הוספת אירוע לגדוד/פלוגה/צוות/חייל ⭐</div>
      <div class="placeholder">יצירת משימה לכל הפלוגות/צוותים ⭐</div>
      <div class="placeholder">יצירת משימה לחייל ספציפי ⭐</div>
      <div class="placeholder">עריכת אירוע / מחיקה ⭐</div>
      <div class="placeholder">אירוע ארוך (מתאריך עד תאריך) ⭐</div>
      <div class="placeholder">Log לאירוע (מי הוסיף ומתי – בתוך אירוע) ⭐</div>
    </div>
  `,

  platoon_schedule: (user)=>`
    <h2>לו״ז ומשימות פלוגתי – ${escapeHtml(user.platoon)} <span class="badge">⭐ שרת</span></h2>
    <p class="muted">אדמין פלוגתי יכול להוסיף אירוע וגם ליצור משימות לפלוגה / לצוותים / לחיילים בפלוגה בלבד (בדמו – תצוגה).</p>

    <div class="divider"></div>

    <h3 style="margin:0 0 8px 0;">לו״ז פלוגתי להיום (דמו)</h3>
    <table>
      <thead><tr><th style="width:90px;">שעה</th><th>פעילות</th><th style="width:120px;">היקף</th></tr></thead>
      <tbody>
        ${DEMO_DB.platoonSchedule.map(e=>`<tr><td>${escapeHtml(e.when)}</td><td>${escapeHtml(e.title)}</td><td>${escapeHtml(e.scope)}</td></tr>`).join('')}
      </tbody>
    </table>

    <div class="divider"></div>

    <h3 style="margin:0 0 8px 0;">משימות אישיות (דמו)</h3>
    <table>
      <thead><tr><th>משימה</th><th style="width:140px;">למי</th><th style="width:120px;">דדליין</th><th style="width:110px;">סטטוס</th></tr></thead>
      <tbody>
        ${DEMO_DB.personalTasks
          .filter(t=>soldiersInScope(user).some(s=>s.id===t.who))
          .map(t=>{
            const s = soldierById(t.who)||{name:'—',id:t.who};
            return `<tr><td>${escapeHtml(t.title)}</td><td>${escapeHtml(s.name)} • ${escapeHtml(s.id)}</td><td>${escapeHtml(t.due)}</td><td>${escapeHtml(t.status)} ⭐</td></tr>`;
          }).join('')}
      </tbody>
    </table>

    <div class="divider"></div>

    <div class="grid">
      <div class="placeholder">הוספת אירוע לפלוגה ⭐</div>
      <div class="placeholder">יצירת משימה לכל הפלוגה/צוותים ⭐</div>
      <div class="placeholder">יצירת משימה לחייל ספציפי ⭐</div>
      <div class="placeholder">עריכה/מחיקה + Log ⭐</div>
    </div>
  `,

  learning: ()=>`
    <h2>למידה <span class="badge">⭐ שרת</span></h2>
    <p class="muted">חיילים רואים מערכי שיעור ומשימות "לעבור מערך". מסמנים "קראתי".</p>
    <div class="grid">
      <div class="placeholder">רשימת מערכים</div>
      <div class="placeholder">כפתור: קראתי ✓</div>
      <div class="placeholder">נוצרה משימה אוטומטית ⭐</div>
      <div class="placeholder">סטטוס השלמה ⭐</div>
    </div>
  `,

  learning_admin: (user)=>`
    <h2>למידה – ניהול <span class="badge">⭐ שרת</span></h2>
    <p class="muted">
      העלאת PDF/Word/וידאו/תמונה + מעקב מי קרא (ירוק/אדום) + יצירת משימה לחיילים.
      ${user.role === 'platoon_admin' ? '<br/><strong>מוגבל לפלוגה שלך.</strong>' : ''}
      ${user.role === 'battalion_admin' ? '<br/><strong>ברמת גדוד.</strong>' : ''}
    </p>
    <div class="grid">
      <div class="placeholder">העלאת קובץ + שם מערך ⭐</div>
            <div class="placeholder"><span class="badge badgeGood">קראו</span> רשימה ירוקה ⭐</div>
      <div class="placeholder"><span class="badge badgeBad">לא קראו</span> רשימה אדומה ⭐</div>
    </div>
  `,

  logistics: (user)=>{
  const sub = DEMO_STATE.logisticsSubTab || 'requests';
  const setSub = (id)=>{ DEMO_STATE.logisticsSubTab = id; renderApp(); };

  const inv = DEMO_DB.inventory;
  const myScope = (user.role==='platoon_admin') ? `פלוגה ${user.platoon}` :
                  (user.role==='battalion_admin') ? `גדוד ${user.battalion}` :
                  (user.role==='sys_admin') ? 'כל היחידות' : 'יחידה';

  const visibleReqs = (user.role==='platoon_admin')
    ? DEMO_STATE.requests.filter(r=>String(r.scope||'').includes(`פלוגה ${user.platoon}`) || String(r.scope||'').includes(`פלוגה ${user.platoon}`.replace('פלוגה ','פלוגה ')))
    : DEMO_STATE.requests;


  // תמונת מצב לוגיסטית (דמו): נשק/ציוד לחימה/מלאי-אפסניה ברמת חייל ופלוגה
  const scopedSoldiers = visibleSoldiersFor(user).filter(s=>{
    if(user.role==='platoon_admin') return s.platoon === user.platoon;
    return true;
  });

  const weaponRows = scopedSoldiers.map(s=>{
    const w = (DEMO_DB.soldierLogistics[s.id]?.weapons || []);
    if(!w.length){
      return `<tr>
        <td>${escapeHtml(s.platoon)}</td>
        <td>${escapeHtml(s.team||'')}</td>
        <td><strong>${escapeHtml(s.name)}</strong> <span class="muted">(${escapeHtml(s.id)})</span></td>
        <td><span class="badge badgeBad">בלי נשק</span></td>
        <td class="muted">—</td>
        <td class="muted">—</td>
      </tr>`;
    }
    return w.map(x=>`<tr>
        <td>${escapeHtml(s.platoon)}</td>
        <td>${escapeHtml(s.team||'')}</td>
        <td><strong>${escapeHtml(s.name)}</strong> <span class="muted">(${escapeHtml(s.id)})</span></td>
        <td>${escapeHtml(x.name)}</td>
        <td>${escapeHtml(x.sku||'')}</td>
        <td>${escapeHtml(x.serial||'')}</td>
      </tr>`).join('');
  }).join('');

  // ציוד לחימה "בחוץ" = ציוד שמוקצה לחיילים
  const combatItems = {};
  scopedSoldiers.forEach(s=>{
    (DEMO_DB.soldierLogistics[s.id]?.equipment || []).forEach(it=>{
      const key = `${it.name}||${it.sku||''}`;
      combatItems[key] = (combatItems[key]||0) + (it.qty||0);
    });
  });
  const combatRows = Object.entries(combatItems).map(([k,qty])=>{
    const [name,sku]=k.split('||');
    return `<tr><td>${escapeHtml(name)}</td><td>${escapeHtml(sku)}</td><td>${qty}</td></tr>`;
  }).join('') || `<tr><td colspan="3" class="muted">אין נתונים</td></tr>`;

  const dashHtml = `
    <div class="card" style="margin-bottom:12px;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <strong>תמונת מצב לוגיסטית – ${escapeHtml(myScope)}</strong>
          <div class="muted">כל המידע בדמו להמחשה בלבד. ⭐ בשרת: מקור אמת + הרשאות + Audit.</div>
        </div>
        <div class="row">
          <span class="pill">חיילים בטווח: <strong>${scopedSoldiers.length}</strong></span>
          <span class="pill">פריטי מלאי: <strong>${inv.length}</strong></span>
        </div>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <h3 style="margin:0 0 8px 0;">נשקים לפי חייל (שם + סוג + מק״ט + מס׳ סידורי) ⭐</h3>
      <table class="table">
        <thead><tr><th>פלוגה</th><th>צוות</th><th>חייל</th><th>נשק</th><th>מק״ט</th><th>מס׳ סידורי</th></tr></thead>
        <tbody>${weaponRows || `<tr><td colspan="6" class="muted">אין נתונים</td></tr>`}</tbody>
      </table>
      <div class="placeholder">⭐ בשרת: סנכרון נשקיה, סטטוס “חתום/מוחזר/תקול”, ודוחות חריגים</div>
    </div>

    <div class="grid">
      <div class="card">
        <h3 style="margin:0 0 8px 0;">ציודי לחימה בחוץ (סה״כ) ⭐</h3>
        <table class="table">
          <thead><tr><th>פריט</th><th>מק״ט</th><th>כמות</th></tr></thead>
          <tbody>${combatRows}</tbody>
        </table>
        <div class="placeholder">⭐ בשרת: “מי חתום על מה” ברמת פריט/מס׳ סידורי</div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0;">באפסנאות/מחסן (דמו) ⭐</h3>
        <table class="table">
          <thead><tr><th>פריט</th><th>מק״ט</th><th>במלאי</th></tr></thead>
          <tbody>
            ${inv.map(x=>`
              <tr>
                <td>${escapeHtml(x.name)}</td>
                <td>${escapeHtml(x.sku)}</td>
                <td>${Number(x.inStock||0) > 0 ? `<span class="badge badgeGood">${x.inStock}</span>` : `<span class="badge badgeBad">0</span>`}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div class="placeholder">⭐ בשרת: מלאי לפי מחסן/פלוגה, בעלות/השאלה, והיסטוריית תנועות</div>
      </div>
    </div>
  `;
  const requestsHtml = `
    <div class="row" style="justify-content:space-between;">
      <div>
        <strong>בקשות ציוד ${user.role==='logistics' ? 'לטיפול' : 'להגשה/מעקב'}</strong>
        <div class="muted">⭐ בשרת: שמירה, סטטוסים, תיוג אגם, הרשאות, והיסטוריה.</div>
      </div>
      ${(user.role==='platoon_admin' || user.role==='battalion_admin' || user.role==='sys_admin') ? `<button class="btnSm btnSmPrimary" id="openReqModal">➕ בקשה לציוד ⭐</button>` : ``}
    </div>

    <div style="height:10px;"></div>

    <table class="table">
      <thead>
        <tr>
          <th>תאריך</th>
          <th>בקשה</th>
          <th>תחום</th>
          <th>סטטוס כללי</th>
          <th>פריטים</th>
        </tr>
      </thead>
      <tbody>
        ${visibleReqs.map(r=>{
          const status = computeRequestStatus(r);
          const items = (r.items||[]).map(it=>`${it.product} x${it.qty} — ${it.decision==='pending'?'ממתין':'✓'}`).join('<br/>');
          return `
            <tr>
              <td>${escapeHtml(r.createdAt||'')}</td>
              <td><strong>${escapeHtml(r.id)}</strong><div class="muted">מגיש/ה: ${escapeHtml(r.requesterName||'')} (${escapeHtml(r.requesterRole||'')})</div></td>
              <td>${escapeHtml(r.scope||myScope)}</td>
              <td>${escapeHtml(status)}</td>
              <td>${items}</td>
            </tr>
            ${user.role==='logistics' ? `
              <tr>
                <td colspan="5">
                  <div class="muted" style="margin-bottom:6px;">טיפול לוגיסטיקה בפריטים (דמו)</div>
                  <table class="table">
                    <thead><tr><th>מוצר</th><th>כמות</th><th style="width:240px;">סימון לוגיסטיקה ⭐</th></tr></thead>
                    <tbody>
                      ${(r.items||[]).map((it, i)=>`
                        <tr>
                          <td>${escapeHtml(it.product)}</td>
                          <td>${escapeHtml(String(it.qty))}</td>
                          <td>
                            <select data-req="${escapeHtml(r.id)}" data-item="${i}" class="decSel">
                              <option value="pending" ${it.decision==='pending'?'selected':''}>ממתין</option>
                              <option value="in_stock" ${it.decision==='in_stock'?'selected':''}>קיים במלאי</option>
                              <option value="out_of_stock" ${it.decision==='out_of_stock'?'selected':''}>לא קיים במלאי</option>
                              <option value="needs_agam" ${it.decision==='needs_agam'?'selected':''}>צריך אישור אגם</option>
                            </select>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </td>
              </tr>
            ` : ``}
          `;
        }).join('') || `<tr><td colspan="5" class="muted">אין בקשות כרגע.</td></tr>`}
      </tbody>
    </table>
  `;

  const inventoryHtml = `
    <strong>מלאי (דמו)</strong>
    <div class="muted">⭐ בשרת: התחברות למחסן/ימ״ח/נשקיה + דוחות.</div>
    <div style="height:10px;"></div>
    <table class="table">
      <thead><tr><th>מוצר</th><th>מק״ט</th><th>במלאי</th></tr></thead>
      <tbody>
        ${inv.map(i=>`
          <tr>
            <td>${escapeHtml(i.name)}</td>
            <td>${escapeHtml(i.sku)}</td>
            <td>${i.inStock>0?`<span class="badge badgeGood">כן (${i.inStock})</span>`:`<span class="badge badgeBad">אין</span>`}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;

  const platoonHtml = `
    <strong>לוגיסטיקה פלוגתית (דמו)</strong>
    <div class="muted">מטרת המסך: לתת “תחושה” מה יהיה בשרת.</div>
    <div style="height:10px;"></div>
    <div class="grid">
      <div class="placeholder">חוסרים פלוגתיים ⭐ (לדוגמה: 2 קסדות חסרות)</div>
      <div class="placeholder">דוח מלאי פלוגתי ⭐ (לפי צוותים)</div>
      <div class="placeholder">העברות ציוד בין צוותים ⭐</div>
    </div>
  `;

  const soldierCardHtml = `
    <strong>כרטיס חייל – לוגיסטיקה (דמו)</strong>
    <div class="muted">בחירת חייל והצגת ציוד/נשק/אמר״ל להמחשה.</div>
    <div style="height:10px;"></div>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr));">
      <div>
        <div class="muted" style="margin-bottom:6px;">בחר חייל</div>
        <select id="logSoldierPick">
          ${visibleSoldiersFor(user).map(s=>`<option value="${escapeHtml(s.id)}">${escapeHtml(s.id)} • ${escapeHtml(s.name)}</option>`).join('')}
        </select>
        <div style="height:10px;"></div>
        <button class="btnSm" id="openSoldierCard">פתח כרטיס ⭐</button>
      </div>
      <div class="placeholder">בשרת: היסטוריית העברות, חתימות, תקלות, אישורים ⭐</div>
    </div>
    <div id="logSoldierCardArea"></div>
  `;

  return `
    <h2>לוגיסטיקה <span class="badge">⭐ שרת</span></h2>
    <p class="muted">כולל “ציוד” בתוך לוגיסטיקה. אדמין/שליש רואים לפי הרשאה; לוגיסטיקה מטפלים בבקשות.</p>

    <div class="subTabs">
      <button class="${sub==='dash'?'active':''}" data-sub="dash">תמונת מצב</button>
      <button class="${sub==='requests'?'active':''}" data-sub="requests">בקשות ציוד</button>
      <button class="${sub==='inventory'?'active':''}" data-sub="inventory">מלאי</button>
      <button class="${sub==='platoon'?'active':''}" data-sub="platoon">פלוגתי</button>
      <button class="${sub==='soldier'?'active':''}" data-sub="soldier">כרטיס חייל</button>
    </div>

    ${sub==='dash' ? dashHtml : ''}

    ${sub==='requests' ? requestsHtml : ''}
    ${sub==='inventory' ? inventoryHtml : ''}
    ${sub==='platoon' ? platoonHtml : ''}
    ${sub==='soldier' ? soldierCardHtml : ''}
  `;
},


  platoon_hr: (user)=>{
    const u = user || {};
    const scoped = { ...u, role:'platoon_admin' };
    return Screens.hr(scoped);
  },

  hr: (user)=>{
  const soldiers = visibleSoldiersFor(user);
  const platoons = [...new Set(soldiers.map(s=>s.platoon))];

  const inOrder = soldiers.filter(s=>s.order);
  const notInOrder = soldiers.filter(s=>!s.order);
  const outTasks = soldiers.filter(s=>s.outTask);

  const row = (s)=>`
    <tr>
      <td>${escapeHtml(s.id)}</td>
      <td><strong>${escapeHtml(s.name)}</strong><div class="muted">פלוגה ${escapeHtml(s.platoon)} • ${escapeHtml(s.team)}</div></td>
      <td>${escapeHtml((s.mos||[]).map(mosToText).join(', ') || '—')}</td>
      <td>${s.medical ? `<span class="badge">${escapeHtml(s.medical)}</span>` : `<span class="muted">—</span>`}</td>
      <td>${escapeHtml(s.notes||'')}</td>
    </tr>
  `;

  const platoonBlock = (p)=>{
    const list = soldiers.filter(s=>s.platoon===p);
    const pIn = list.filter(s=>s.order);
    const pOut = list.filter(s=>!s.order);
    const pOT = list.filter(s=>s.outTask);

    return `
      <div class="card" style="margin:0;">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <strong>פלוגה ${escapeHtml(p)}</strong>
            <div class="muted">סה״כ: ${list.length} • בצו: ${pIn.length} • לא בצו: ${pOut.length}${pOT.length?` • משימות חוץ: ${pOT.length}`:''}</div>
          </div>
        </div>

        <div style="height:10px;"></div>

        <table class="table">
          <thead><tr><th>מס׳</th><th>חייל</th><th>מקצועות</th><th>בריאות</th><th>הערות</th></tr></thead>
          <tbody>${list.map(row).join('') || `<tr><td colspan="5" class="muted">—</td></tr>`}</tbody>
        </table>
      </div>
    `;
  };

  return `
    <h2>שלישות <span class="badge">⭐ שרת</span></h2>
    <p class="muted">
      דמו: תצוגה של חיילים בצו/לא בצו/משימות חוץ + הערות פרטניות (גימלים וכו׳) + <strong>חלוקה לפי פלוגות</strong>.
      בשרת: פילוחים אמיתיים + ניהול צווים + הרשמות חדשות.
    </p>

    <h3 style="margin:0 0 10px 0;">חלוקה לפי פלוגות</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(320px,1fr));">
      ${platoons.map(platoonBlock).join('') || `<div class="placeholder">אין חיילים בדמו</div>`}
    </div>

    <div class="divider"></div>

    <div class="grid">
      <div class="card" style="margin:0;">
        <strong>חיילים בצו</strong>
        <table class="table">
          <thead><tr><th>מס׳</th><th>חייל</th><th>מקצועות</th><th>בריאות</th><th>הערות</th></tr></thead>
          <tbody>${inOrder.map(row).join('') || `<tr><td colspan="5" class="muted">—</td></tr>`}</tbody>
        </table>
      </div>

      <div class="card" style="margin:0;">
        <strong>חיילים לא בצו / חריגים</strong>
        <table class="table">
          <thead><tr><th>מס׳</th><th>חייל</th><th>מקצועות</th><th>בריאות</th><th>הערות</th></tr></thead>
          <tbody>${notInOrder.map(row).join('') || `<tr><td colspan="5" class="muted">—</td></tr>`}</tbody>
        </table>
      </div>

      <div class="card" style="margin:0;">
        <strong>חיילים במשימות חוץ</strong>
        <table class="table">
          <thead><tr><th>מס׳</th><th>חייל</th><th>מקצועות</th><th>בריאות</th><th>הערות</th></tr></thead>
          <tbody>${outTasks.map(row).join('') || `<tr><td colspan="5" class="muted">—</td></tr>`}</tbody>
        </table>
      </div>
    </div>

    <div class="divider"></div>
    <div class="row">
      <button class="btnSm" id="openRegisterFromHR">⭐ רישום חייל חדש</button>
    </div>
  `;
},


  approvals: ()=>`
    <h2>אישורים <span class="badge">⭐ שרת</span></h2>
    <p class="muted">אישור משתמשים, זיכוי ציוד, אישור העברות.</p>
    <div class="grid">
      <div class="placeholder">אישור משתמשים ⭐</div>
      <div class="placeholder">אישור זיכוי ציוד ⭐</div>
      <div class="placeholder">אישור העברות ציוד ⭐</div>
      <div class="placeholder">Audit Log ⭐</div>
    </div>
  `,

  approvals_platoon: (user)=>`
    <h2>אישורים פלוגתיים – פלוגה ${escapeHtml(user.platoon)} <span class="badge">⭐ שרת</span></h2>
    <p class="muted">אדמין פלוגתי מאשר רק דברים של הפלוגה שלו (כוח אדם/ציוד/קריאות).</p>
    <div class="grid">
      <div class="placeholder">אישור קריאה להודעות בפלוגה ⭐</div>
      <div class="placeholder">אישור העברות ציוד בפלוגה ⭐</div>
      <div class="placeholder">בקשות זיכוי ציוד בפלוגה ⭐</div>
      <div class="placeholder">Log פלוגתי ⭐</div>
    </div>
  `,


  hr_platoon: (user)=>{
    // שלישות פלוגתית: מי בצו/לא בצו/משימות חוץ + חלוקה לצוותים + הערות
    const soldiers = visibleSoldiersFor(user).filter(s=>s.platoon === user.platoon);
    const teams = [...new Set(soldiers.map(s=>s.team||'ללא צוות'))];

    const inOrder = soldiers.filter(s=>s.order);
    const notInOrder = soldiers.filter(s=>!s.order);
    const outTasks = soldiers.filter(s=>s.outTask);

    const badge = (ok)=> ok ? '<span class="badge badgeGood">בצו</span>' : '<span class="badge badgeBad">לא בצו</span>';

    const soldierRow = (s)=>`
      <tr>
        <td>${escapeHtml(s.id)}</td>
        <td><strong>${escapeHtml(s.name)}</strong><div class="muted">${escapeHtml(s.team||'')}</div></td>
        <td>${badge(!!s.order)}</td>
        <td>${s.outTask ? '<span class="badge">משימות חוץ</span>' : ''}</td>
        <td>${s.medical ? `<span class="badge badgeBad">${escapeHtml(s.medical)}</span>` : '<span class="muted">—</span>'}</td>
        <td class="muted">${escapeHtml(s.notes||'')}</td>
      </tr>
    `;

    const teamBlock = (team)=>{
      const list = soldiers.filter(s=>(s.team||'ללא צוות')===team);
      return `
        <div class="card" style="margin-bottom:12px;">
          <div class="row" style="justify-content:space-between;">
            <div><strong>${escapeHtml(team)}</strong> <span class="muted">(${list.length})</span></div>
            <div class="muted">⭐ בשרת: סנכרון צו/תיקים רפואיים/משימות חוץ</div>
          </div>
          <div style="height:8px;"></div>
          <table class="table">
            <thead><tr><th>אישי</th><th>שם</th><th>סטטוס צו</th><th>משימות חוץ</th><th>הערה רפואית</th><th>הערות</th></tr></thead>
            <tbody>${list.map(soldierRow).join('') || `<tr><td colspan="6" class="muted">אין חיילים</td></tr>`}</tbody>
          </table>
        </div>
      `;
    };

    return `
      <h2>שלישות פלוגתית – פלוגה ${escapeHtml(user.platoon)} <span class="badge">⭐ שרת</span></h2>
      <p class="muted">תמונת מצב כוח אדם פלוגתית ברמה שמית: צו / לא צו / משימות חוץ / הערות (דמו).</p>

      <div class="grid">
        <div class="card">
          <div><strong>בצו</strong></div>
          <div class="muted">${inOrder.length} חיילים</div>
        </div>
        <div class="card">
          <div><strong>לא בצו</strong></div>
          <div class="muted">${notInOrder.length} חיילים</div>
        </div>
        <div class="card">
          <div><strong>משימות חוץ</strong></div>
          <div class="muted">${outTasks.length} חיילים</div>
        </div>
        <div class="card">
          <div><strong>צוותים</strong></div>
          <div class="muted">${teams.length} צוותים</div>
        </div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;">חלוקה לפי צוותים (דמו)</h3>
      ${teams.map(teamBlock).join('')}

      <div class="placeholder">⭐ בשרת: מסננים (גימלים/פרופיל/זמינות), ייצוא, ותיעוד היסטורי</div>
    `;
  },

  platoon_messages: (user)=>`
    <h2>הודעות פלוגה – פלוגה ${escapeHtml(user.platoon)} <span class="badge">⭐ שרת</span></h2>
    <p class="muted">שליחת הודעות מתפרצות לפי היררכיה – מוגבל לפלוגה.</p>
    <div class="grid">
      <div class="placeholder">שליחת הודעה לפלוגה ⭐</div>
      <div class="placeholder">שלח שוב למי שלא אישר ⭐</div>
      <div class="placeholder">רשימת קראו / לא קראו ⭐</div>
      <div class="placeholder">שולח + זמן שליחה בתוך ההודעה ⭐</div>
    </div>
  `,

  soldier_search: (user)=>{
  const soldiers = visibleSoldiersFor(user);
  const mosFilter = state.soldierSearch.mos || '';
  const q = (state.soldierSearch.q||'').trim();
  const filtered = soldiers.filter(s=>{
    const byName = !q || (s.name||'').includes(q) || (s.id||'').includes(q);
    const byMos = !mosFilter || (s.mos||[]).some(m=>m.type===mosFilter);
    return byName && byMos;
  });
  const selId = state.soldierSearch.selectedId || (filtered[0]?.id||'');
  const sel = filtered.find(s=>s.id===selId) || filtered[0];
  const log = sel ? (DEMO_DB.soldierLogistics[sel.id]||{equipment:[],weapons:[],amaral:[]}) : null;
  const mosText = sel ? (sel.mos||[]).map(mosToText).join(', ') : '';

  return `
    <h2>חיפוש חייל <span class="badge">⭐ שרת</span></h2>
    <p class="muted">בדמו: חיפוש לפי שם/מס׳ אישי + סינון לפי מקצוע צבאי. בשרת: חיפוש אמיתי + הרשאות.</p>

    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
      <div>
        <div class="muted" style="margin-bottom:6px;">חיפוש (שם/מספר אישי)</div>
        <input id="sSearchQ" value="${escapeHtml(state.soldierSearch.q||'')}" placeholder="נועם / 1001 ..." />
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px;">סינון לפי מקצוע</div>
        <select id="sSearchMos">
          <option value="">הכל</option>
          ${MOS_TYPES.map(t=>`<option value="${escapeHtml(t)}" ${t===mosFilter?'selected':''}>${escapeHtml(t)}</option>`).join('')}
        </select>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px;">תוצאות</div>
        <select id="sSearchPick">
          ${filtered.map(s=>`<option value="${escapeHtml(s.id)}" ${s.id===selId?'selected':''}>${escapeHtml(s.id)} • ${escapeHtml(s.name)} • פלוגה ${escapeHtml(s.platoon)} • ${escapeHtml(s.team)}</option>`).join('')}
        </select>
      </div>
    </div>

    <div class="divider"></div>

    ${!sel ? `<div class="placeholder">אין תוצאות</div>` : `
      <div class="card" style="background:#fff; border:1px solid var(--border);">
        <div class="row" style="justify-content:space-between;">
          <div>
            <strong>${escapeHtml(sel.name)}</strong> <span class="muted">(${escapeHtml(sel.id)})</span>
            <div class="muted">גדוד ${escapeHtml(sel.battalion)} • פלוגה ${escapeHtml(sel.platoon)} • ${escapeHtml(sel.team)}</div>
            <div class="muted">מקצועות: <strong>${escapeHtml(mosText||'—')}</strong></div>
            <div class="muted">סטטוס: ${sel.order?'<span class="badge badgeGood">בצו</span>':'<span class="badge badgeBad">לא בצו</span>'}
              ${sel.outTask?'<span class="badge">משימות חוץ</span>':''}
              ${sel.medical?`<span class="badge">${escapeHtml(sel.medical)}</span>`:''}
            </div>
          </div>
          <div class="row">
            <button class="btnSm" id="openRegisterFromSearch">⭐ רישום חייל חדש</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr));">
          <div>
            <strong>ציוד</strong>
            <table class="table">
              <thead><tr><th>פריט</th><th>מק״ט</th><th>כמות</th></tr></thead>
              <tbody>${(log.equipment||[]).map(i=>`<tr><td>${escapeHtml(i.name)}</td><td>${escapeHtml(i.sku)}</td><td>${escapeHtml(String(i.qty))}</td></tr>`).join('') || `<tr><td colspan="3" class="muted">—</td></tr>`}</tbody>
            </table>
          </div>

          <div>
            <strong>נשק</strong>
            <table class="table">
              <thead><tr><th>פריט</th><th>מק״ט</th><th>מס׳ סידורי</th></tr></thead>
              <tbody>${(log.weapons||[]).map(i=>`<tr><td>${escapeHtml(i.name)}</td><td>${escapeHtml(i.sku)}</td><td>${escapeHtml(i.serial||'')}</td></tr>`).join('') || `<tr><td colspan="3" class="muted">—</td></tr>`}</tbody>
            </table>
          </div>

          <div>
            <strong>אמר״ל</strong>
            <table class="table">
              <thead><tr><th>פריט</th><th>מק״ט</th><th>כמות</th></tr></thead>
              <tbody>${(log.amaral||[]).map(i=>`<tr><td>${escapeHtml(i.name)}</td><td>${escapeHtml(i.sku)}</td><td>${escapeHtml(String(i.qty))}</td></tr>`).join('') || `<tr><td colspan="3" class="muted">—</td></tr>`}</tbody>
            </table>
          </div>
        </div>
      </div>
    `}
  `;
},

  messages: (user)=>`
    <h2>הודעות <span class="badge">⭐ שרת</span></h2>
    <p class="muted">בדמו: הודעות דוגמה. בפרודקשן יהיה "קראתי" חובה + מי אישר + שלח שוב למי שלא אישר.</p>

    <div class="divider"></div>

    <div class="grid">
      ${DEMO_DB.messages.map(m=>`
        <div class="card" style="margin:0; box-shadow:none;">
          <div class="row" style="justify-content:space-between;">
            <div>
              <strong>${escapeHtml(m.title)}</strong>
              <div class="muted">מאת: ${escapeHtml(m.from)} • ${escapeHtml(m.at)}</div>
            </div>
            <span class="badge">⭐</span>
          </div>
          <div style="height:8px;"></div>
          <div>${escapeHtml(m.body)}</div>
          <div style="height:10px;"></div>
          <div class="tblActions">
            <button class="btnSm">קראתי ✓ <span class="hintStar">⭐</span></button>
            <button class="btnSm">שלח שוב למי שלא אישר <span class="hintStar">⭐</span></button>
          </div>
        </div>
      `).join('')}
    </div>
  `,

  chat: ()=>`
    <h2>צ׳אט <span class="badge">⭐ שרת</span></h2>
    <p class="muted">צ׳אט מבצעי (דמו). דורש שרת/Realtime.</p>
    <div class="placeholder">חלון שיחה + שליחה ⭐</div>
  `,

  3010: ()=>`
    <h2>3010 <span class="badge">⭐ שרת</span></h2>
    <p class="muted">סימולטור + הורדת PDF (אחר כך).</p>
    <div class="grid">
      <div class="placeholder">ימי שמ״פ מצטבר ⭐</div>
      <div class="placeholder">חישוב שכר משוער ⭐</div>
      <div class="placeholder">הורדת PDF ⭐</div>
      <div class="placeholder">Log מי הוריד ומתי ⭐</div>
    </div>
  `,

    dashboard: (user)=>{
  const soldiers = visibleSoldiersFor(user);
  const inOrder = soldiers.filter(s=>s.order);
  const notInOrder = soldiers.filter(s=>!s.order);
  const outTasks = soldiers.filter(s=>s.outTask);
  const medical = soldiers.filter(s=>!!s.medical);

  const teams = [...new Set(soldiers.map(s=>s.team))];
  const platoons = [...new Set(soldiers.map(s=>s.platoon))];

  const badge = (s)=>{
    const parts = [];
    parts.push(s.order ? `<span class="badge badgeGood">בצו</span>` : `<span class="badge badgeBad">לא בצו</span>`);
    if(s.outTask) parts.push(`<span class="badge">משימות חוץ</span>`);
    if(s.medical) parts.push(`<span class="badge">${escapeHtml(s.medical)}</span>`);
    return parts.join(' ');
  };

  const row = (s)=>`
    <tr>
      <td>${escapeHtml(s.id)}</td>
      <td><strong>${escapeHtml(s.name)}</strong><div class="muted">פלוגה ${escapeHtml(s.platoon)} • ${escapeHtml(s.team)}</div></td>
      <td>${badge(s)}</td>
      <td class="muted">${escapeHtml((s.mos||[]).map(mosToText).join(', ') || '—')}</td>
    </tr>
  `;

  const teamCards = teams.map(t=>{
    const list = soldiers.filter(s=>s.team===t);
    const tIn = list.filter(s=>s.order).length;
    const tOut = list.filter(s=>!s.order).length;
    const tOT = list.filter(s=>s.outTask).length;
    const tMed = list.filter(s=>s.medical).length;
    return `
      <div class="card" style="margin:0;">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <strong>${escapeHtml(t)}</strong>
            <div class="muted">סה״כ: ${list.length} • בצו: ${tIn} • לא בצו: ${tOut}${tOT?` • משימות חוץ: ${tOT}`:''}${tMed?` • גימלים/בריאות: ${tMed}`:''}</div>
          </div>
        </div>
        <div style="height:8px;"></div>
        <table class="table">
          <thead><tr><th>מס׳</th><th>חייל</th><th>סטטוס</th><th>מקצועות</th></tr></thead>
          <tbody>${list.map(row).join('') || `<tr><td colspan="4" class="muted">—</td></tr>`}</tbody>
        </table>
      </div>
    `;
  }).join('');

  const platoonCards = platoons.map(p=>{
    const list = soldiers.filter(s=>s.platoon===p);
    const pIn = list.filter(s=>s.order).length;
    const pOut = list.filter(s=>!s.order).length;
    return `
      <div class="card" style="margin:0;">
        <strong>פלוגה ${escapeHtml(p)}</strong>
        <div class="muted">סה״כ: ${list.length} • בצו: ${pIn} • לא בצו: ${pOut}</div>
      </div>
    `;
  }).join('');

  const roleLabel = ROLE_DEFS[user.role]?.label || '';
  const isPlatoonAdmin = user.role === 'platoon_admin';

  return `
    <h2>תמונת מצב</h2>
    <div class="row">
      <span class="pill">מחובר/ת כ: <strong>${escapeHtml(roleLabel)}</strong></span>
      <span class="pill">${escapeHtml(scopeChip(user))}</span>
      <span class="pill">כח אדם נראה בדמו: <strong>${soldiers.length}</strong></span>
    </div>

    <div class="divider"></div>

    ${isPlatoonAdmin ? `
      <p class="muted">
        אדמין פלוגתי: דמו תצוגת כוח אדם לפי צוותים + מי בצו/לא בצו + חריגים. (⭐ בשרת זה מתעדכן בזמן אמת)
      </p>

      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));">
        <div class="card" style="margin:0;">
          <strong>בצו</strong>
          <div class="muted">סה״כ: ${inOrder.length}</div>
        </div>
        <div class="card" style="margin:0;">
          <strong>לא בצו</strong>
          <div class="muted">סה״כ: ${notInOrder.length}</div>
        </div>
        <div class="card" style="margin:0;">
          <strong>משימות חוץ</strong>
          <div class="muted">סה״כ: ${outTasks.length}</div>
        </div>
        <div class="card" style="margin:0;">
          <strong>גימלים/בריאות</strong>
          <div class="muted">סה״כ: ${medical.length}</div>
        </div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 10px 0;">חלוקה לפי צוותים</h3>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(320px,1fr));">
        ${teamCards || `<div class="placeholder">אין צוותים בדמו</div>`}
      </div>
    ` : `
      <p class="muted">דשבורד אדמין/מחלקה. רואים תמצית לפי הרשאה (⭐ שרת) + פילוח בדמו.</p>

      <div class="grid">
        <div class="card" style="margin:0;">
          <strong>בצו</strong><div class="muted">${inOrder.length}</div>
        </div>
        <div class="card" style="margin:0;">
          <strong>לא בצו</strong><div class="muted">${notInOrder.length}</div>
        </div>
        <div class="card" style="margin:0;">
          <strong>משימות חוץ</strong><div class="muted">${outTasks.length}</div>
        </div>
        <div class="card" style="margin:0;">
          <strong>פילוח פלוגות</strong><div class="muted">דמו</div>
          <div style="height:8px;"></div>
          <div class="grid" style="grid-template-columns:1fr; gap:8px;">
            ${platoonCards || `<div class="muted">—</div>`}
          </div>
        </div>
      </div>
    `}
  `;
},
  small_forces: (user)=> {
    const teams = (DEMO_DB.smallForces && DEMO_DB.smallForces.teams) ? DEMO_DB.smallForces.teams : [];
    const assigns = (DEMO_DB.smallForces && DEMO_DB.smallForces.assignments) ? DEMO_DB.smallForces.assignments : [];
    const byTeam = {};
    assigns.forEach(a=>{
      byTeam[a.team] = byTeam[a.team] || [];
      byTeam[a.team].push(a);
    });
    const teamCards = teams.map(t=>{
      const list = (byTeam[t.team]||[]).slice(0,25).map(a=>{
        const s = soldierById(a.soldierId);
        return `<tr>
          <td>${escapeHtml(s? s.name : a.soldierId)}</td>
          <td>${escapeHtml(s? s.platoon : '')}</td>
          <td>${escapeHtml(a.status||'')}</td>
          <td>${escapeHtml(a.commanderName||'')}</td>
          <td>${escapeHtml(a.commanderPhone||'')}</td>
        </tr>`;
      }).join('') || `<tr><td colspan="5" class="muted">אין שיבוצים</td></tr>`;
      return `
        <div class="card" style="margin:12px 0;">
          <div class="row" style="justify-content:space-between;">
            <strong>צוות ${escapeHtml(t.team)}</strong>
            <span class="pill">מפקד צוות: ${escapeHtml(t.commanderName||'')} • ${escapeHtml(t.commanderPhone||'')}</span>
          </div>
          <div class="divider"></div>
          <table class="table">
            <thead><tr><th>חייל</th><th>מקור (פלוגה)</th><th>סטטוס</th><th>מפקד צוות</th><th>טל׳</th></tr></thead>
            <tbody>${list}</tbody>
          </table>
          <div class="muted">⭐ הוספה/הסרה/אישור — דורש שרת</div>
        </div>`;
    }).join('');
    return `
      <h2>כוחות קטנים</h2>
      <div class="muted">תצוגת דמו: צוותים בלבד, סטטוס ממתין/פעיל, ושמירת היסטוריה ⭐</div>
      ${teamCards}
    `;
  },



rashmatz: (user)=>{
  const u = user||{role:'soldier', name:'', platoon:'', team:'', battalion:''};
  const canAdmin = (u.role==='sys_admin' || u.role==='battalion_admin' || u.role==='platoon_admin');
  const scope = (DEMO_DB._rashmatzUI?.view)||'platoon';
  const scopes = [
    {id:'personal', label:'אישי'},
    {id:'team', label:'צוותי'},
    {id:'platoon', label:'פלוגתי'},
  ];
  const items = (DEMO_DB.rashmatz||[]).filter(r=>{
    if(scope==='personal') return r.scope==='personal' && r.ownerId===u.id;
    if(scope==='team') return r.scope==='team' && r.team===u.team && r.platoon===u.platoon && r.battalion===u.battalion;
    return r.scope==='platoon' && r.platoon===u.platoon && r.battalion===u.battalion;
  });

  const oe = DEMO_DB.orangeEyes || {items:[], lastCheckedAt:null, lastCheckedBy:''};
  const inv = (DEMO_DB.sabotage?.inventory)||[];
  const usage = (DEMO_DB.sabotage?.usage)||[];

  const listHtml = items.length ? items.map(r=>{
    const last = r.lastCheckedAt ? `<span class="muted">בדיקה אחרונה: <strong>${escapeHtml(r.lastCheckedBy||'')}</strong> • ${escapeHtml(r.lastCheckedAt||'')}</span>` : `<span class="muted">טרם נבדק</span>`;
    const delBtn = (canDeleteRashmatz(u, r)) ? `<button class="btnLight" data-action="rashmatz_delete" data-id="${escapeHtml(r.id)}">מחיקה ⭐</button>` : ``;
    return `
      <div class="card" style="margin:12px 0; border:1px solid var(--border);">
        <div class="row" style="justify-content:space-between;">
          <div>
            <strong>${escapeHtml(r.title)}</strong>
            <div class="muted">נוצר ע״י ${escapeHtml(r.createdBy)} • ${escapeHtml(r.createdAt)}</div>
          </div>
          <div class="row" style="gap:8px;">
            ${delBtn}
            <button class="btnLight" data-action="rashmatz_check" data-id="${escapeHtml(r.id)}">✓ נבדק ⭐</button>
            <button class="btnLight" data-action="rashmatz_shortage" data-id="${escapeHtml(r.id)}">חוסר ⭐</button>
          </div>
        </div>
        <div class="divider"></div>
        <div class="muted" style="margin-bottom:8px;">${last}</div>
        <div style="overflow:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr>
                <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">פריט</th>
                <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">כמות</th>
                <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">נבדק אחרון</th>
              </tr>
            </thead>
            <tbody>
              ${(r.rows||[]).map(row=>`
                <tr>
                  <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(row.name)}</td>
                  <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(String(row.qty||''))}</td>
                  <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml((row.lastCheckedBy||r.lastCheckedBy||'') + (row.lastCheckedAt||r.lastCheckedAt ? ' • ' + (row.lastCheckedAt||r.lastCheckedAt) : ''))}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }).join('') : `<div class="placeholder">אין עדיין רשמ״צים ב${scopeLabel(scope)}. צור חדש ⭐</div>`;

  const platoonExtras = (scope==='platoon') ? `
    <div class="card" style="margin:12px 0; border:1px solid var(--border);">
      <div class="row" style="justify-content:space-between;">
        <div>
          <strong>כתום בעיניים</strong>
          <div class="muted">כולם יכולים לסמן נבדק; רק אדמין מוסיף/מוריד פריטים ⭐</div>
        </div>
        <div class="row" style="gap:8px;">
          ${canAdmin ? `<button class="btnLight" data-action="oe_add">➕ הוסף פריט ⭐</button>` : ``}
          <button class="btnLight" data-action="oe_check">✓ נבדק ⭐</button>
        </div>
      </div>
      <div class="divider"></div>
      <div class="muted">בדיקה אחרונה: <strong>${escapeHtml(oe.lastCheckedBy||'')}</strong> ${oe.lastCheckedAt?('• '+escapeHtml(oe.lastCheckedAt)):'(טרם נבדק)'}</div>
      <div style="overflow:auto; margin-top:10px;">
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">פריט</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">חתום על</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">אגף</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">אחרון נבדק</th>
            </tr>
          </thead>
          <tbody>
            ${(oe.items||[]).map(it=>`
              <tr>
                <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(it.name)}</td>
                <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(it.assignedTo||'')}</td>
                <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(it.dept||'')}</td>
                <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml((it.lastCheckedBy||'') + (it.lastCheckedAt ? ' • ' + it.lastCheckedAt : ''))}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        ${(oe.items||[]).length ? '' : '<div class="placeholder" style="margin-top:10px;">אין פריטים (דמו)</div>'}
      </div>
    </div>

    <div class="card" style="margin:12px 0; border:1px solid var(--border);">
      <div class="row" style="justify-content:space-between;">
        <div>
          <strong>רשמ״ץ חבלה</strong>
          <div class="muted">מלאי + יומן שימושים. הוספה/שימוש ⭐</div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btnLight" data-action="sabot_add">➕ הוסף פריט ⭐</button>
          <button class="btnLight" data-action="sabot_use">חבלה ששומש ⭐</button>
        </div>
      </div>
      <div class="divider"></div>
      ${renderSabotagePanel(inv, usage)}
    </div>
  ` : '';

  return `
    <h2>רשמ״ץ <span class="badge">⭐ שרת</span></h2>
    <div class="row" style="justify-content:space-between;">
      <div class="row" style="gap:8px; flex-wrap:wrap;">
        ${scopes.map(s=>`
          <button class="${(scope===s.id)?'btn btnPrimary':'btn btnLight'}" style="width:auto; padding:8px 10px; border-radius:10px;" data-action="rashmatz_view" data-scope="${s.id}">${escapeHtml(s.label)}</button>
        `).join('')}
      </div>
      <div class="row" style="gap:8px;">
        <button class="btn btnLight" style="width:auto;" data-action="rashmatz_new">➕ רשמ״ץ חדש ⭐</button>
      </div>
    </div>
    <div class="divider"></div>
    ${listHtml}
    ${platoonExtras}
  `;
},

};


function scopeLabel(scope){
  if(scope==='personal') return 'אישי';
  if(scope==='team') return 'צוותי';
  return 'פלוגתי';
}

function canDeleteRashmatz(user, rash){
  if(!user || !rash) return false;
  const isAdmin = (user.role==='sys_admin' || user.role==='battalion_admin' || user.role==='platoon_admin');
  const isCreator = (rash.createdById && user.id && rash.createdById===user.id) || (rash.createdBy===user.name);
  return isAdmin || isCreator;
}

function nowISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}

function saveDemo(){
  try{
    if(window.localStorage){
      localStorage.setItem('DEMO_DB_V8', JSON.stringify(DEMO_DB));
    }
  }catch(e){}
}

function loadDemo(){
  try{
    if(window.localStorage){
      const raw = localStorage.getItem('DEMO_DB_V8');
      if(raw){
        const parsed = JSON.parse(raw);
        Object.assign(DEMO_DB, parsed);
      }
    }
  }catch(e){}
}

function renderSabotagePanel(inv, usage){
  inv = inv || [];
  usage = usage || [];
  const invHtml = inv.length ? `
    <div style="overflow:auto;">
      <table style="width:100%; border-collapse:collapse; font-size:13px;">
        <thead>
          <tr>
            <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">פריט</th>
            <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">כמות</th>
            <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">יחידה</th>
          </tr>
        </thead>
        <tbody>
          ${inv.map(it=>`
            <tr>
              <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(it.name)}</td>
              <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(String(it.qty||0))}</td>
              <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(it.unit||'יח׳')}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  ` : `<div class="placeholder">אין מלאי חבלה (דמו)</div>`;

  const usageHtml = usage.length ? `
    <div style="margin-top:12px;">
      <div class="muted" style="margin-bottom:6px;">יומן שימושים</div>
      <div style="overflow:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">מתי</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">מי מילא</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">פעילות</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">צוות</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">פריט</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">כמות</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">יח׳</th>
            </tr>
          </thead>
          <tbody>
            ${usage.slice().reverse().map(u=>`
              <tr>
                <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(u.at)}</td>
                <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(u.by)}</td>
                <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(u.activity)}</td>
                <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(u.team)}</td>
                <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(u.item)}</td>
                <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(String(u.qty))}</td>
                <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(u.unit)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  ` : `<div class="placeholder" style="margin-top:10px;">אין רישומי שימוש (דמו)</div>`;

  return invHtml + usageHtml;
}


function renderLogin(root){
  root.innerHTML = `
    <div class="loginWrap">
      <div class="card loginCard">
        <h2 style="margin:0 0 6px 0;">כניסה למערכת (דמו)</h2>
        <div class="muted">בחרי תפקיד כדי לראות איך המערכת נראית לכל אחד (כולל אדמין פלוגתי/גדודי).</div>

        <div class="divider"></div>

        <div class="grid2">
          <button class="btn btnRole" data-role="soldier">
            <strong>חייל</strong><span>דף בית, לו״ז, למידה, 3010, צ׳אט</span>
          </button>
          <button class="btn btnRole" data-role="shalish">
            <strong>שליש</strong><span>שלישות + לו״ז/משימות לפי הרשאה + הודעות</span>
          </button>
          <button class="btn btnRole" data-role="logistics">
            <strong>לוגיסטיקה</strong><span>ציוד/דוחות/העברות + לו״ז/משימות + הודעות</span>
          </button>
          <button class="btn btnRole" data-role="platoon_admin">
            <strong>אדמין פלוגתי</strong><span>פלוגה בלבד: לו״ז/משימות, הודעות פלוגה, אישורים פלוגתיים</span>
          </button>
          <button class="btn btnRole" data-role="battalion_admin">
            <strong>אדמין גדודי</strong><span>גדוד: לו״ז/משימות + רוחב, אישורים, חיפוש חייל, לוגיסטיקה</span>
          </button>
          <button class="btn btnRole" data-role="sys_admin">
            <strong>מנהל מערכת</strong><span>הכל (דמו)</span>
          </button>
        </div>

        <div class="divider"></div>

        <div class="muted" style="margin-bottom:8px;">
          או התחברי לפי "שם משתמש" (sys / battalion / platoon / shalish / logistics / israel)
        </div>
        <form id="loginForm">
          <input id="loginInput" placeholder="שם משתמש לדמו" autocomplete="off" />
          <div style="height:10px;"></div>
          <button class="btn btnPrimary" type="submit">כניסה</button>
        </form>

        <div style="height:10px;"></div>
        <button id="registerSoldier" class="btn btnLight" type="button">⭐ רישום חייל חדש (דמו)</button>

        <div style="height:10px;"></div>
        <button id="loginGoogle" class="btn btnLight" type="button">⭐ התחברות עם Google (בעתיד)</button>
      </div>
    </div>
  `;

  root.querySelectorAll('[data-role]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const role = btn.getAttribute('data-role');
      loginAs(role);
    });
  });

  root.querySelector('#loginForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const v = (root.querySelector('#loginInput').value || '').trim().toLowerCase();
    if(v === 'sys') return loginAs('sys_admin');
    if(v === 'battalion') return loginAs('battalion_admin');
    if(v === 'platoon') return loginAs('platoon_admin');
    if(v === 'shalish') return loginAs('shalish');
    if(v === 'logistics') return loginAs('logistics');
    if(v === 'israel') return loginAs('soldier');
    alert('משתמש לא נמצא (דמו: sys / battalion / platoon / shalish / logistics / israel)');
  });

  const rb = root.querySelector('#registerSoldier');
  if(rb) rb.addEventListener('click', ()=>{
    openModal('register_soldier', { form:{ id:'', name:'', battalion:'ס׳3', platoon:'א', team:'צוות 1', mosRows:[] } });
  });

  root.querySelector('#loginGoogle').addEventListener('click', ()=>{
    alert('⭐ בדמו אין Google Auth. כשנעבור לשרת נוריד את הכוכבית ונחבר OAuth + אישור אדמין.');
  });
}


/* -----------------------------
 * DEMO SEED (דאטה “מערכת חיה”) ⭐
 * - יוצר חיילים רנדומליים סביב גדוד ס׳5 והפלוגות שהוגדרו
 * - מוסיף מקצועות, ציוד חתום, פרטי תזונה/בריאות, וסטטוס צו
 * - נשמר ב-localStorage כדי שיהיה יציב בין רענונים
 * ----------------------------- */
function seedDemoData(){
  try {
    const KEY = 'DEMO_SEED_V8_S5';
    if(window.localStorage && localStorage.getItem(KEY) === '1') return;

    const S5_PLATOONS = ['ס״פ א׳','ס״פ ב׳','תופז','גבעול','יאפ דרום','ספיר צפון','ספיר דרום','ספיר מרכז'];
    const TEAMS = ['צוות 1','צוות 2','צוות 3'];

    const firstNames = ['נועם','אורי','יואב','דניאל','איתי','שחר','עידו','עומר','תמר','מאיה','אילה','רוני','מיכל','אלון','נדב','שיר','ליאור','גיא','אופק','אריאל'];
    const lastNames  = ['כהן','לוי','מזרחי','ביטון','פרץ','דיין','שטרן','אוחנה','גולד','ברק','שגב','אדרי','סגל','מלכה','חדד','בן-דוד','אברהם','כץ','רז','סויסה'];
    const ranks = ['טוראי','רב״ט','סמל','סמ״ר','רס״ל'];
    const bloodTypes = ['O+','O-','A+','A-','B+','B-','AB+','AB-'];
    const dietTypes = ['בשרי','צמחוני','טבעוני'];
    const drugAllergies = ['אין','פניצילין','איבופרופן','אמוקסיצילין','סולפה'];

    const mosPool = [
      { type:'סלק' },
      { type:'חובש' },
      { type:'נהג ב', permits:['B','C1'] },
      { type:'נהג ג', permits:['C','C1'] },
      { type:'מטיס רחפן', drones:['DJI Mavic 3','Autel Evo','Skydio'] },
      { type:'מערכת שיקוף', systemTypes:['שיקוף X','שיקוף Y','שיקוף Z'] },
    ];

    const gearCatalog = [
      { name:'ווסט קרמי', sku:'VST-100' },
      { name:'קסדה', sku:'HLM-210' },
      { name:'מחסניות 5.56', sku:'MAG-556', qty:[2,6] },
      { name:'משקפת', sku:'OPT-330' },
      { name:'שק״ש', sku:'SLP-090' },
      { name:'ערכת עזרה ראשונה', sku:'MED-001' },
      { name:'מכשיר קשר', sku:'COM-777' },
      { name:'פנס טקטי', sku:'LGT-420' },
      { name:'אפוד זיהוי', sku:'IDV-050' },
    ];

    function r(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function rint(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function pickN(arr, n){
      const copy = arr.slice();
      const out = [];
      while(copy.length && out.length < n){
        out.push(copy.splice(Math.floor(Math.random()*copy.length),1)[0]);
      }
      return out;
    }
    function pad(n, len){ n = String(n); return n.padStart(len,'0'); }

    // Ensure DEMO_DB exists
    if(typeof DEMO_DB !== 'object' || !Array.isArray(DEMO_DB.soldiers)) return;

    // Add soldiers per platoon (5-10 open order + 5-10 closed)
    const baseId = 6000;
    let idCounter = baseId + (DEMO_DB.soldiers?.length || 0);

    const today = new Date();
    function daysAgo(n){ const d = new Date(today); d.setDate(d.getDate()-n); return d; }
    function daysFrom(n){ const d = new Date(today); d.setDate(d.getDate()+n); return d; }
    function fmt(d){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // Keep existing S5 soldiers; only append new unique IDs
    const existingIds = new Set((DEMO_DB.soldiers||[]).map(s=>String(s.id)));

    S5_PLATOONS.forEach((platoon, pi)=>{
      const openN = rint(5,10);
      const closedN = rint(5,10);

      function makeSoldier(isOpen){
        // generate unique id
        let sid;
        do { sid = String(++idCounter); } while(existingIds.has(sid));
        existingIds.add(sid);

        const fn = r(firstNames);
        const ln = r(lastNames);
        const team = r(TEAMS);
        const rank = r(ranks);
        const diet = r(dietTypes);
        const allergy = r(drugAllergies);
        const blood = r(bloodTypes);

        // MOS: 1-3
        const mos = pickN(mosPool, rint(1,3)).map(m=>{
          const row = { type: m.type };
          if(m.permits) row.permits = pickN(m.permits, rint(1, m.permits.length));
          if(m.drones) row.drones = pickN(m.drones, rint(1, Math.min(2, m.drones.length)));
          if(m.systemTypes) row.systemType = r(m.systemTypes);
          return row;
        });

        // Order info
        const start = daysAgo(rint(1,120));
        const end = isOpen ? daysFrom(rint(5,90)) : daysAgo(rint(1,90));
        const status = isOpen ? 'מגויס' : 'משוחרר';

        // Assignment
        const isExternal = isOpen ? (Math.random()<0.25) : false;
        const ext = isExternal ? {
          kind:'משימת חוץ',
          mission: r(['שמירה','אבטחה','קשר','מענה רפואי','תצפית','רחפנות','נהיגה']),
          under: r(['מ״פ תופז','מ״פ גבעול','קמב״ץ גדוד','קצין לוגיסטיקה','קצין קשר']),
        } : { kind:'פלוגה', mission:'', under:'' };

        // Logistics signed gear
        const gearN = rint(3,6);
        const gear = pickN(gearCatalog, gearN).map(g=>{
          const qty = g.qty ? rint(g.qty[0], g.qty[1]) : 1;
          const where = Math.random()<0.7 ? 'חתום אצל החייל' : 'באפסון/ימ״ח';
          return { name:g.name, sku:g.sku, qty, where, signedAt: fmt(daysAgo(rint(1,200))) };
        });

        // Weapon + armel demo
        const weaponTypes = [
          { name:'M4', sku:'WPN-100', serial:`M4-${pad(rint(1,99999),5)}` },
          { name:'תבור X95', sku:'WPN-210', serial:`X95-${pad(rint(1,99999),5)}` },
          { name:'M16', sku:'WPN-050', serial:`M16-${pad(rint(1,99999),5)}` },
        ];
        const armelTypes = [
          { name:'אפוד אמר״ל', sku:'ARM-300' },
          { name:'ערכת ניקוי נשק', sku:'ARM-120' },
          { name:'משקפי מגן', sku:'ARM-080' },
        ];
        const hasWeapon = Math.random()<0.8;
        const weapon = hasWeapon ? r(weaponTypes) : null;
        const armel = pickN(armelTypes, rint(1,2));

        // "כל מה שאפשר למלא" (כרטיס חייל)
        const profile = {
          id: sid,
          name: `${fn} ${ln}`,
          battalion: "ס׳5",
          platoon,
          team,
          rank,
          phone: `05${rint(0,9)}-${pad(rint(0,9999999),7)}`,
          address: `רח׳ ${r(['הדקל','הזית','האלון','הנחל','הפרדס'])} ${rint(1,99)}, ${r(['באר שבע','ירושלים','חיפה','ת״א','אשדוד','נצרת'])}`,
          kids: rint(0,4),
          partnerName: `${r(firstNames)} ${r(lastNames)}`,
          partnerPhone: `05${rint(0,9)}-${pad(rint(0,9999999),7)}`,
          bloodType: blood,
          drugSensitivity: allergy,
          diet,
          dietNote: diet === 'בשרי' ? 'רגיל' : (diet === 'צמחוני' ? 'ללא בשר' : 'ללא מוצרים מן החי'),
          roles: ['לוחם'],
          rolesExtra: [],
          mosRows: mos,
          order: {
            status,
            openedAt: fmt(start),
            expectedClose: fmt(end),
            assignment: ext.kind,
            mission: ext.mission,
            under: ext.under,
            notes: (Math.random()<0.2) ? 'גימלים עד מחר' : ((Math.random()<0.2) ? 'הגבלה רפואית קלה' : ''),
            audit: [
              { by:'שליש (דמו)', at: fmt(daysAgo(rint(0,30))), action:'הזנה/עדכון צו' },
            ],
          },
          logistics: {
            weapon,
            armel,
            gearSigned: gear,
            notes: (Math.random()<0.15) ? 'חסר קסדה – בטיפול' : '',
          },
          // flags
          isActive: true,
        };

        return profile;
      }

      for(let i=0;i<openN;i++) DEMO_DB.soldiers.push(makeSoldier(true));
      for(let i=0;i<closedN;i++) DEMO_DB.soldiers.push(makeSoldier(false));
    });

    // Mark as seeded
    if(window.localStorage) localStorage.setItem(KEY,'1');
  } catch(e){
    console.warn('seedDemoData error', e);
  }
}

let state = {
  user: null,
  activeTabId: null,
  modal: null,
  soldierSearch: { q:'', mos:'', selectedId:'' },
};

function loginAs(role){
  const def = ROLE_DEFS[role] || ROLE_DEFS.soldier;
  state.user = { role, ...def };
  const t = tabsForRole(role);

  // Defaults per role (דמו)
  if(role === 'logistics'){
    state.activeTabId = 'logistics';
    DEMO_DB.logisticsSubTab = 'dashboard';
  } else if(role === 'platoon_admin'){
    state.activeTabId = 'dashboard';
  } else {
    state.activeTabId = t[0]?.id || 'home';
  }

  renderApp();
}


function wireRashmatzActions(){
  document.querySelectorAll('[data-action]').forEach(btn=>{
    if(btn._wired) return;
    btn._wired = true;
    btn.addEventListener('click', ()=>{
      const a = btn.getAttribute('data-action');
      const u = state.user || {};
      if(a === 'rashmatz_view'){
        DEMO_DB._rashmatzUI = DEMO_DB._rashmatzUI || {view:'platoon'};
        DEMO_DB._rashmatzUI.view = btn.getAttribute('data-scope') || 'platoon';
        saveDemo();
        renderApp();
        return;
      }
      if(a === 'rashmatz_new'){
        alert('⭐ בדמו: יצירת רשמ״ץ חדש (בשרת: טופס מלא מוצר/כמות + היקף אישי/צוותי/פלוגתי)');
        return;
      }
      if(a === 'rashmatz_check'){
        const id = btn.getAttribute('data-id');
        const r = (DEMO_DB.rashmatz||[]).find(x=>String(x.id)===String(id));
        if(r){
          r.lastCheckedAt = nowISO();
          r.lastCheckedBy = u.name || 'משתמש (דמו)';
          (r.rows||[]).forEach(row=>{
            row.lastCheckedAt = r.lastCheckedAt;
            row.lastCheckedBy = r.lastCheckedBy;
          });
          saveDemo();
          renderApp();
        }
        return;
      }
      if(a === 'rashmatz_shortage'){
        alert('⭐ בדמו: סימון חוסר לפריט + מי מילא ומתי + תיעוד (בשרת)');
        return;
      }
      if(a === 'rashmatz_delete'){
        const id = btn.getAttribute('data-id');
        const r = (DEMO_DB.rashmatz||[]).find(x=>String(x.id)===String(id));
        if(r && canDeleteRashmatz(u, r)){
          DEMO_DB.rashmatz = (DEMO_DB.rashmatz||[]).filter(x=>String(x.id)!==String(id));
          saveDemo();
          renderApp();
        } else {
          alert('אין הרשאה למחוק (דמו)');
        }
        return;
      }
      if(a === 'oe_check'){
        DEMO_DB.orangeEyes = DEMO_DB.orangeEyes || {items:[], lastCheckedAt:null, lastCheckedBy:''};
        DEMO_DB.orangeEyes.lastCheckedAt = nowISO();
        DEMO_DB.orangeEyes.lastCheckedBy = u.name || 'משתמש (דמו)';
        (DEMO_DB.orangeEyes.items||[]).forEach(it=>{
          it.lastCheckedAt = DEMO_DB.orangeEyes.lastCheckedAt;
          it.lastCheckedBy = DEMO_DB.orangeEyes.lastCheckedBy;
        });
        saveDemo();
        renderApp();
        return;
      }
      if(a === 'oe_add'){
        alert('⭐ בדמו: הוספת פריט לכתום בעיניים כולל מי חתום + שיוך אגף בלוגיסטיקה');
        return;
      }
      if(a === 'sabot_add'){
        alert('⭐ בדמו: הוספת פריט לרשמ״ץ חבלה (לבנות/פצצונות/מחז/...) + כמות + יח׳/מטר');
        return;
      }
      if(a === 'sabot_use'){
        alert('⭐ בדמו: רישום "חבלה ששומש" (מה שומש/כמות/פעילות/תאריך/צוות) והפחתה מהמלאי + לוג');
        return;
      }
    });
  });
}

function logout(){
  state.user = null;
  state.activeTabId = null;
  render();
}

function renderHeader(){
  const u = state.user;
  const title = u ? `ניהול יחידתי – דמו` : `מערכת ניהול יחידתית – דמו`;
  const sub = u ? `שלום, ${u.name} • ${screenTitle(u)} • ⭐ לא מחובר לשרת` : `⭐ לא מחובר לשרת`;
  return `
    <header>
      <div>
        <h1>${escapeHtml(title)}</h1>
        <div class="sub">${escapeHtml(sub)}</div>
      </div>
      <div class="right">
        ${u ? `<button id="logoutBtn">התנתקות</button>` : ``}
      </div>
    </header>
  `;
}

function renderNav(tabs){
  return `
    <nav id="nav">
      ${tabs.map(t=>`
        <button class="${t.id===state.activeTabId?'active':''}" data-tab="${t.id}">
          ${escapeHtml(t.label)}
        </button>
      `).join('')}
    </nav>
  `;
}

function renderView(){
  const u = state.user;
  const tab = state.activeTabId;
  const fn = Screens[tab];
  const html = fn ? fn(u) : `<div class="placeholder">מסך דמו</div>`;
  return `<main><div class="card">${html}</div></main>`;
}

function wireNav(){
  document.querySelectorAll('[data-tab]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      state.activeTabId = btn.getAttribute('data-tab');
      renderApp();
    });
  });
  const lb = document.getElementById('logoutBtn');
  if(lb) lb.addEventListener('click', logout);
}


function wireScreenHandlers(){
  const u = state.user;
  const tab = state.activeTabId;

  // --- Logistics: admin request modal + tables
  if(tab === 'logistics' && u && (u.role==='platoon_admin' || u.role==='battalion_admin' || u.role==='sys_admin')){
    const modal = document.getElementById('reqModal');
    const openBtn = document.getElementById('openReqModal');
    const closeBtn = document.getElementById('closeReqModal');
    const cancelBtn = document.getElementById('cancelReq');
    const addRowBtn = document.getElementById('addReqRow');
    const submitBtn = document.getElementById('submitReq');
    const itemsBody = document.getElementById('reqItemsBody');

    function openModal(){
      if(!modal) return;
      modal.classList.add('show');
      // seed one row if empty
      if(itemsBody && !itemsBody.children.length) addRow();
    }
    function closeModal(){
      if(!modal) return;
      modal.classList.remove('show');
    }
    function addRow(p='', q='1'){
      if(!itemsBody) return;
      const rid = uid('row');
      const tr = document.createElement('tr');
      tr.setAttribute('data-row', rid);
      tr.innerHTML = `
        <td><input data-field="product" placeholder="מוצר (דמו)" value="${escapeHtml(p)}"/></td>
        <td><input data-field="qty" type="number" min="1" value="${escapeHtml(String(q||1))}"/></td>
        <td><button class="btnSm btnSmDanger" data-remove="${rid}">מחק</button></td>
      `;
      itemsBody.appendChild(tr);
      tr.querySelector('[data-remove]').addEventListener('click', ()=> tr.remove());
    }

    function renderRequestsForAdmin(){
      const tb = document.getElementById('reqTableBody');
      if(!tb) return;

      const scopeLabel = (u.role==='platoon_admin') ? `פלוגה ${u.platoon}׳` : (u.role==='battalion_admin' ? `גדוד ${u.battalion}` : 'הכל');
      const mine = DEMO_STATE.requests.filter(r=> r.requesterRole===roleLabel(u.role) || r.scope.includes(u.platoon) || r.scope.includes(u.battalion) || u.role==='sys_admin');

      tb.innerHTML = mine.map(r=>{
        const itemsTxt = r.items.map(it=>`${escapeHtml(it.product)} × ${escapeHtml(String(it.qty))}`).join('<br/>');
        const statusTxt = r.items.map(it=>escapeHtml(it.decision||'צריך סימון לוגיסטיקה')).join('<br/>');
        return `
          <tr>
            <td>${escapeHtml(r.id)}</td>
            <td>${escapeHtml(r.createdAt)}</td>
            <td>${escapeHtml(r.scope || scopeLabel)}</td>
            <td>${itemsTxt}</td>
            <td>${statusTxt}</td>
          </tr>
        `;
      }).join('') || `<tr><td colspan="5" class="muted">אין בקשות עדיין.</td></tr>`;
    }

    function renderSoldierCard(targetId){
      const box = document.getElementById('soldierCardBox');
      if(!box) return;
      const s = soldierById(targetId);
      const log = DEMO_DB.soldierLogistics[targetId];
      if(!s || !log){
        box.innerHTML = 'לא נמצא כרטיס חייל (דמו).';
        return;
      }
      const eq = log.equipment.map(e=>`<tr><td>${escapeHtml(e.name)}</td><td>${escapeHtml(e.sku)}</td><td>${escapeHtml(String(e.qty))}</td></tr>`).join('');
      const wp = log.weapons.map(w=>`<tr><td>${escapeHtml(w.name)}</td><td>${escapeHtml(w.sku)}</td><td>${escapeHtml(w.serial)}</td></tr>`).join('');
      box.classList.remove('placeholder');
      box.innerHTML = `
        <div class="card" style="margin:0; box-shadow:none;">
          <div class="row" style="justify-content:space-between;">
            <div>
              <strong>${escapeHtml(s.name)}</strong>
              <div class="muted">אישי: ${escapeHtml(s.id)} • פלוגה ${escapeHtml(s.platoon)} • ${escapeHtml(s.team)}</div>
            </div>
            <span class="badge">⭐ שרת</span>
          </div>

          <div class="divider"></div>

          <h4 style="margin:0 0 8px 0;">ציוד (דמו)</h4>
          <table>
            <thead><tr><th>פריט</th><th style="width:140px;">מק״ט</th><th style="width:120px;">כמות</th></tr></thead>
            <tbody>${eq}</tbody>
          </table>

          <div style="height:12px;"></div>

          <h4 style="margin:0 0 8px 0;">נשק (דמו)</h4>
          <table>
            <thead><tr><th>פריט</th><th style="width:140px;">מק״ט</th><th style="width:160px;">מס׳ סידורי</th></tr></thead>
            <tbody>${wp}</tbody>
          </table>
        </div>
      `;
    }

    // wire
    if(openBtn) openBtn.addEventListener('click', openModal);
    if(closeBtn) closeBtn.addEventListener('click', closeModal);
    if(cancelBtn) cancelBtn.addEventListener('click', closeModal);
    if(addRowBtn) addRowBtn.addEventListener('click', ()=>addRow());
    if(submitBtn) submitBtn.addEventListener('click', ()=>{
      const rows = Array.from((itemsBody||{children:[]}).children);
      const items = rows.map(tr=>{
        const p = tr.querySelector('[data-field="product"]')?.value?.trim() || '';
        const q = Number(tr.querySelector('[data-field="qty"]')?.value || 0);
        return { product:p, qty: q>0?q:1, decision:'צריך סימון לוגיסטיקה' };
      }).filter(it=>it.product);
      if(!items.length){ alert('צריך לפחות מוצר אחד (דמו).'); return; }

      const scope = (u.role==='platoon_admin') ? `פלוגה ${u.platoon}׳` : (u.role==='battalion_admin' ? `גדוד ${u.battalion}` : 'הכל');
      DEMO_STATE.requests.unshift({
        id: uid('req'),
        createdAt: fmtDate(new Date()),
        scope,
        requesterRole: roleLabel(u.role),
        requesterName: u.name,
        items,
      });

      // reset modal rows
      if(itemsBody) itemsBody.innerHTML = '';
      closeModal();
      renderApp(); // רענון מסך
    });

    const openCardBtn = document.getElementById('openSoldierCard');
    const picker = document.getElementById('soldierPicker');
    if(openCardBtn && picker){
      openCardBtn.addEventListener('click', ()=> renderSoldierCard(picker.value));
    }

    renderRequestsForAdmin();
  }

  // --- Logistics: logistics role processes requests
  if(tab === 'logistics' && u && u.role==='logistics'){
    const body = document.getElementById('logiReqBody');
    if(body){
      const options = ['קיים במלאי', 'לא קיים במלאי', 'צריך אישור אגם'];
      body.innerHTML = DEMO_STATE.requests.map(r=>{
        const itemsHtml = r.items.map((it, idx)=>{
          const selId = `${r.id}-${idx}`;
          const opts = options.map(o=>`<option ${it.decision===o?'selected':''} value="${o}">${o}</option>`).join('');
          return `
            <div style="border:1px dashed var(--dashBorder); background:var(--dashBg); border-radius:12px; padding:10px; margin:0 0 8px 0;">
              <div><strong>${escapeHtml(it.product)}</strong> × ${escapeHtml(String(it.qty))}</div>
              <div style="height:6px;"></div>
              <select data-req="${escapeHtml(r.id)}" data-idx="${idx}">${opts}</select>
            </div>
          `;
        }).join('');
        return `
          <tr>
            <td>${escapeHtml(r.id)}</td>
            <td>${escapeHtml(r.createdAt)}</td>
            <td>${escapeHtml(r.scope)}</td>
            <td>${escapeHtml(r.requesterRole)}</td>
            <td>${itemsHtml}</td>
          </tr>
        `;
      }).join('') || `<tr><td colspan="5" class="muted">אין בקשות כרגע.</td></tr>`;

      body.querySelectorAll('select[data-req]').forEach(sel=>{
        sel.addEventListener('change', ()=>{
          const rid = sel.getAttribute('data-req');
          const idx = Number(sel.getAttribute('data-idx'));
          const req = DEMO_STATE.requests.find(x=>x.id===rid);
          if(req && req.items[idx]) req.items[idx].decision = sel.value;
        });
      });
    }
  }

  // --- Soldier search card wiring
  if(tab === 'soldier_search'){
    const picker = document.getElementById('searchSoldierPicker');
    const btn = document.getElementById('openSearchSoldierCard');
    const box = document.getElementById('searchSoldierCardBox');

    function renderCard(id){
      const s = soldierById(id);
      const log = DEMO_DB.soldierLogistics[id];
      if(!box) return;
      if(!s || !log){
        box.innerHTML = 'לא נמצא (דמו).';
        return;
      }
      const notes = [s.medical, s.notes, s.order?'בצו':'לא בצו', s.outTask?'משימות חוץ':''].filter(Boolean).join(' • ');
      box.classList.remove('placeholder');
      box.innerHTML = `
        <div class="card" style="margin:0; box-shadow:none;">
          <div class="row" style="justify-content:space-between;">
            <div>
              <strong>${escapeHtml(s.name)}</strong>
              <div class="muted">אישי: ${escapeHtml(s.id)} • פלוגה ${escapeHtml(s.platoon)} • ${escapeHtml(s.team)}</div>
              <div class="muted">${escapeHtml(notes)}</div>
            </div>
            <span class="badge">⭐ שרת</span>
          </div>

          <div class="divider"></div>

          <h4 style="margin:0 0 8px 0;">ציוד</h4>
          <table>
            <thead><tr><th>פריט</th><th style="width:140px;">מק״ט</th><th style="width:120px;">כמות</th></tr></thead>
            <tbody>
              ${log.equipment.map(e=>`<tr><td>${escapeHtml(e.name)}</td><td>${escapeHtml(e.sku)}</td><td>${escapeHtml(String(e.qty))}</td></tr>`).join('')}
            </tbody>
          </table>

          <div style="height:12px;"></div>

          <h4 style="margin:0 0 8px 0;">נשק</h4>
          <table>
            <thead><tr><th>פריט</th><th style="width:140px;">מק״ט</th><th style="width:160px;">מס׳ סידורי</th></tr></thead>
            <tbody>
              ${log.weapons.map(w=>`<tr><td>${escapeHtml(w.name)}</td><td>${escapeHtml(w.sku)}</td><td>${escapeHtml(w.serial)}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    if(btn && picker) btn.addEventListener('click', ()=>renderCard(picker.value));
  }
}


function wireScreens(){
  const u = state.user;
  const tab = state.activeTabId;

  // common: open register from HR or soldier_search
  const regFromHR = document.getElementById('openRegisterFromHR');
  if(regFromHR) regFromHR.addEventListener('click', ()=>{
    openModal('register_soldier', { form:{ id:'', name:'', battalion:u?.battalion||'ס׳3', platoon:u?.platoon||'א', team:'צוות 1', mosRows:[] } });
  });

  const regFromSearch = document.getElementById('openRegisterFromSearch');
  if(regFromSearch) regFromSearch.addEventListener('click', ()=>{
    openModal('register_soldier', { form:{ id:'', name:'', battalion:u?.battalion||'ס׳3', platoon:u?.platoon||'א', team:'צוות 1', mosRows:[] } });
  });

  if(tab === 'soldier_search'){
    const q = document.getElementById('sSearchQ');
    if(q) q.addEventListener('input', ()=>{
      state.soldierSearch.q = q.value;
      renderApp();
    });
    const mos = document.getElementById('sSearchMos');
    if(mos) mos.addEventListener('change', ()=>{
      state.soldierSearch.mos = mos.value;
      state.soldierSearch.selectedId = '';
      renderApp();
    });
    const pick = document.getElementById('sSearchPick');
    if(pick) pick.addEventListener('change', ()=>{
      state.soldierSearch.selectedId = pick.value;
      renderApp();
    });
  }

  if(tab === 'logistics'){
    // sub tabs
    document.querySelectorAll('[data-sub]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        DEMO_STATE.logisticsSubTab = btn.getAttribute('data-sub');
        renderApp();
      });
    });

    // open request modal
    const openReq = document.getElementById('openReqModal');
    if(openReq) openReq.addEventListener('click', ()=>{
      openModal('request_equipment', { form:{ scope: (u.role==='platoon_admin')?`פלוגה ${u.platoon}`:(u.role==='battalion_admin')?`גדוד ${u.battalion}`:'רוחב', note:'', items:[{product:'ווסט', qty:1}] } });
    });

    // soldier card open
    const openCard = document.getElementById('openSoldierCard');
    const pick = document.getElementById('logSoldierPick');
    if(openCard && pick) openCard.addEventListener('click', ()=>{
      const id = pick.value;
      const s = DEMO_DB.soldiers.find(x=>x.id===id);
      const log = DEMO_DB.soldierLogistics[id] || {equipment:[],weapons:[],amaral:[]};
      const mosText = (s?.mos||[]).map(mosToText).join(', ');
      const area = document.getElementById('logSoldierCardArea');
      if(area){
        area.innerHTML = `
          <div class="divider"></div>
          <div class="card" style="margin:0; border:1px solid var(--border);">
            <strong>${escapeHtml(s?.name||'')}</strong> <span class="muted">(${escapeHtml(id)})</span>
            <div class="muted">מקצועות: <strong>${escapeHtml(mosText||'—')}</strong></div>
            <div style="height:10px;"></div>
            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr));">
              <div>
                <strong>ציוד</strong>
                <table class="table"><thead><tr><th>פריט</th><th>מק״ט</th><th>כמות</th></tr></thead>
                  <tbody>${(log.equipment||[]).map(i=>`<tr><td>${escapeHtml(i.name)}</td><td>${escapeHtml(i.sku)}</td><td>${escapeHtml(String(i.qty))}</td></tr>`).join('')}</tbody>
                </table>
              </div>
              <div>
                <strong>נשק</strong>
                <table class="table"><thead><tr><th>פריט</th><th>מק״ט</th><th>מס׳ סידורי</th></tr></thead>
                  <tbody>${(log.weapons||[]).map(i=>`<tr><td>${escapeHtml(i.name)}</td><td>${escapeHtml(i.sku)}</td><td>${escapeHtml(i.serial||'')}</td></tr>`).join('')}</tbody>
                </table>
              </div>
              <div>
                <strong>אמר״ל</strong>
                <table class="table"><thead><tr><th>פריט</th><th>מק״ט</th><th>כמות</th></tr></thead>
                  <tbody>${(log.amaral||[]).map(i=>`<tr><td>${escapeHtml(i.name)}</td><td>${escapeHtml(i.sku)}</td><td>${escapeHtml(String(i.qty))}</td></tr>`).join('')}</tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      }
    });

    // logistics decisions
    document.querySelectorAll('.decSel').forEach(sel=>{
      sel.addEventListener('change', ()=>{
        const reqId = sel.getAttribute('data-req');
        const idx = Number(sel.getAttribute('data-item'));
        const req = DEMO_STATE.requests.find(r=>r.id===reqId);
        if(req && req.items && req.items[idx]){
          req.items[idx].decision = sel.value;
        }
        renderApp();
      });
    });
  }
}

function renderApp(){
  const root = document.getElementById('app');
  const u = state.user;
  const tabs = tabsForRole(u.role);

  root.innerHTML = `
    ${renderHeader()}
    ${renderNav(tabs)}
    ${renderView()}
    ${renderModal()}
  `;
  wireNav();
  wireRashmatzActions();
  wireScreenHandlers();
}

function render(){
  const root = document.getElementById('app');
  if(!state.user){
    renderLogin(root);
    return;
  }
  renderApp();
}

loadDemo();
seedDemoData();
render();
</script>

</body>
</html>
